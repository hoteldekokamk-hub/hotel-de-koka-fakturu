<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–•–æ—Ç–µ–ª –î–µ –ö–û–ö–ê - –§–∏–Ω–∞–Ω—Å–∏–∏</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .sync-status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .sync-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .sync-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .sync-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .sync-status.hidden {
            display: none;
        }


        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .btn-small {
            font-size: 12px;
            padding: 6px 12px;
            white-space: nowrap;
        }

        .btn-table {
            font-size: 11px;
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
        }

        .filter-section {
            background: #e8f4f8;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .search-box {
            grid-column: 1 / -1;
        }

        .table-section {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-paid {
            color: #27ae60;
            font-weight: 600;
        }

        .status-unpaid {
            color: #e74c3c;
            font-weight: 600;
        }

        .status-partial {
            color: #f39c12;
            font-weight: 600;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .summary-card.active {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.5);
        }

        .summary-card h3 {
            font-size: 1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card p {
            font-size: 2em;
            font-weight: 700;
        }

        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .history-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 5px;
        }

        .history-dropdown.show {
            display: block;
        }

        .history-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: #f0f4ff;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item-company {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .history-item-details {
            font-size: 0.9em;
            color: #666;
        }

        .history-item-account {
            color: #667eea;
            font-family: monospace;
        }

        .history-item-amount {
            color: #27ae60;
            font-weight: 600;
        }

        .history-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .no-history {
            padding: 15px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        .payment-info {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .payment-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .payment-info-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1em;
            color: #667eea;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #667eea;
        }

        .payments-list {
            margin-top: 20px;
        }

        .payment-item {
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-item.editing {
            border: 2px solid #667eea;
            background: #f0f4ff;
        }

        .payment-item-info {
            flex: 1;
        }

        .payment-item-date {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .payment-item-amount {
            color: #27ae60;
            font-weight: 600;
            font-size: 1.1em;
        }

        .payment-edit-form {
            display: none;
            flex: 1;
            gap: 10px;
        }

        .payment-edit-form.active {
            display: flex;
            flex-direction: column;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .detail-table {
            width: 100%;
            margin-top: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
        }

        .detail-value {
            color: #667eea;
            font-weight: 600;
        }

        /* –ö—É–º—É–ª–∞—Ç–∏–≤–Ω–∞ –∫–∞–ª–∫—É–ª–∞—Ü–∏—ò–∞ */
        .company-summary {
            display: none;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .company-summary.show {
            display: block;
        }

        .company-summary h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .company-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .company-summary-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .company-summary-item-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .company-summary-item-value {
            font-size: 1.5em;
            font-weight: 700;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
            }
            
            .btn, .filter-section, .form-section {
                display: none !important;
            }
            
            .summary-card {
                break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .form-grid,
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .container {
                padding: 15px;
            }

            .actions {
                flex-direction: column;
            }

            .btn-table {
                width: 100%;
            }

            .summary-card p {
                font-size: 1.5em;
            }

            .payment-item {
                flex-direction: column;
                gap: 10px;
            }

            .company-summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè® –•–æ—Ç–µ–ª –î–µ –ö–û–ö–ê</h1>
        <p class="subtitle">–°–∏—Å—Ç–µ–º –∑–∞ —Å–ª–µ–¥–µ—ö–µ –Ω–∞ –≤–ª–µ–∑–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∏</p>

        <div id="syncStatus" class="sync-status hidden"></div>

        <div class="summary">
            <div class="summary-card" id="cardTotal" onclick="showAllInvoices()">
                <h3>–í–∫—É–ø–Ω–æ —Ñ–∞–∫—Ç—É—Ä–∏</h3>
                <p id="totalInvoices">0</p>
            </div>
            <div class="summary-card" id="cardDisplayed" onclick="showDetailReport('displayed')">
                <h3>–ü—Ä–∏–∫–∞–∂–∞–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∏</h3>
                <p id="displayedInvoices">0</p>
            </div>
            <div class="summary-card" id="cardTotalAmount" onclick="showDetailReport('total')">
                <h3>–í–∫—É–ø–Ω–∞ –≤—Ä–µ–¥–Ω–æ—Å—Ç</h3>
                <p id="totalAmount">0 –¥–µ–Ω</p>
            </div>
            <div class="summary-card" id="cardPaid" onclick="showDetailReport('paid')">
                <h3>–ü–ª–∞—Ç–µ–Ω–∏</h3>
                <p id="paidAmount">0 –¥–µ–Ω</p>
            </div>
            <div class="summary-card" id="cardUnpaid" onclick="showDetailReport('unpaid')">
                <h3>–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</h3>
                <p id="unpaidAmount">0 –¥–µ–Ω</p>
            </div>
        </div>

        <div class="form-section">
            <h2 style="margin-bottom: 20px;">‚ûï –î–æ–¥–∞–¥–∏ –Ω–æ–≤–∞ —Ñ–∞–∫—Ç—É—Ä–∞</h2>
            <form id="invoiceForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="companyName">–ò–º–µ –Ω–∞ —Ñ–∏—Ä–º–∞ *</label>
                        <input type="text" id="companyName" placeholder="–ò–º–µ –Ω–∞ —Ñ–∏—Ä–º–∞" required>
                        <div id="companyHistory" class="history-dropdown"></div>
                    </div>
                    <div class="form-group">
                        <label for="invoiceNumber">–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞ *</label>
                        <input type="text" id="invoiceNumber" placeholder="–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞" required>
                    </div>
                    <div class="form-group">
                        <label for="bankAccount">–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞ *</label>
                        <input type="text" id="bankAccount" placeholder="210-0000000000000-00" required>
                        <div id="accountHistory" class="history-dropdown"></div>
                    </div>
                    <div class="form-group">
                        <label for="amount">–°—É–º–∞ (–¥–µ–Ω) *</label>
                        <input type="number" id="amount" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="entryDate">–î–∞—Ç—É–º –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞ *</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="dueDate">–í–∞–ª—É—Ç–∞ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞ *</label>
                        <input type="date" id="dueDate" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="notes">–ó–∞–±–µ–ª–µ—à–∫–∞</label>
                        <textarea id="notes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª–Ω–∏ –∑–∞–±–µ–ª–µ—à–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)"></textarea>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">üíæ –ó–∞—á—É–≤–∞—ò —Ñ–∞–∫—Ç—É—Ä–∞</button>
                </div>
            </form>
        </div>

        <div class="filter-section">
            <h2 style="margin-bottom: 20px;">üîç –§–∏–ª—Ç—Ä–∏ –∑–∞ –ø—Ä–µ–±–∞—Ä—É–≤–∞—ö–µ</h2>
            <div class="search-box form-group">
                <label for="globalSearch">–ü—Ä–µ–±–∞—Ä–∞—ò –ø–æ —Å–∏—Ç–µ –ø–æ–ª–∏—ö–∞</label>
                <input type="text" id="globalSearch" placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò...">
            </div>
            <div class="filter-grid">
                <div class="form-group">
                    <label for="filterStatus">–°—Ç–∞—Ç—É—Å</label>
                    <select id="filterStatus">
                        <option value="">–°–∏—Ç–µ</option>
                        <option value="paid">–ü–ª–∞—Ç–µ–Ω–∏</option>
                        <option value="partial">–î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∏</option>
                        <option value="unpaid">–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterCompany">–§–∏—Ä–º–∞</label>
                    <input type="text" id="filterCompany" placeholder="–ò–º–µ –Ω–∞ —Ñ–∏—Ä–º–∞">
                </div>
                <div class="form-group">
                    <label for="filterAccount">–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞</label>
                    <input type="text" id="filterAccount" placeholder="–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞">
                </div>
                <div class="form-group">
                    <label for="filterInvoiceNumber">–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞</label>
                    <input type="text" id="filterInvoiceNumber" placeholder="–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞">
                </div>
                <div class="form-group">
                    <label for="filterDateFrom">–î–∞—Ç—É–º –æ–¥</label>
                    <input type="date" id="filterDateFrom">
                </div>
                <div class="form-group">
                    <label for="filterDateTo">–î–∞—Ç—É–º –¥–æ</label>
                    <input type="date" id="filterDateTo">
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-warning" onclick="clearFilters()">üîÑ –†–µ—Å–µ—Ç–∏—Ä–∞—ò —Ñ–∏–ª—Ç—Ä–∏</button>
                <button class="btn btn-info" onclick="openAdvancedReport()">üìä –ù–∞–ø—Ä–µ–¥–µ–Ω –∏–∑–≤–µ—à—Ç–∞—ò</button>
                <button class="btn btn-success" onclick="exportToCSV()">üì• –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
                <button class="btn btn-warning" onclick="document.getElementById('csvFileInput').click()">üì§ –ò–º–ø–æ—Ä—Ç CSV</button>
                <button class="btn btn-warning" onclick="document.getElementById('excelFileInput').click()">üì§ –ò–º–ø–æ—Ä—Ç Excel</button>
                <button class="btn btn-primary" onclick="printReport()">üñ®Ô∏è –ü—Ä–∏–Ω—Ç–∞—ò</button>
                <button class="btn btn-success" onclick="manualSync()">‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞—ò</button>
            </div>
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
            <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel(event)">
        </div>

        <!-- –ö—É–º—É–ª–∞—Ç–∏–≤–Ω–∞ –∫–∞–ª–∫—É–ª–∞—Ü–∏—ò–∞ –ø–æ —Ñ–∏—Ä–º–∞ -->
        <div id="companySummary" class="company-summary">
            <h3>
                <span>üè¢</span>
                <span id="companySummaryName"></span>
            </h3>
            <div class="company-summary-grid">
                <div class="company-summary-item">
                    <div class="company-summary-item-label">–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∏</div>
                    <div class="company-summary-item-value" id="companyInvoiceCount">0</div>
                </div>
                <div class="company-summary-item">
                    <div class="company-summary-item-label">–í–∫—É–ø–Ω–∞ –≤—Ä–µ–¥–Ω–æ—Å—Ç</div>
                    <div class="company-summary-item-value" id="companyTotalAmount">0 –¥–µ–Ω</div>
                </div>
                <div class="company-summary-item">
                    <div class="company-summary-item-label">–ü–ª–∞—Ç–µ–Ω–æ</div>
                    <div class="company-summary-item-value" id="companyPaidAmount">0 –¥–µ–Ω</div>
                </div>
                <div class="company-summary-item">
                    <div class="company-summary-item-label">–û—Å—Ç–∞—Ç–æ–∫ (–¥–æ–ª–∂–∞–º)</div>
                    <div class="company-summary-item-value" id="companyRemainingAmount">0 –¥–µ–Ω</div>
                </div>
            </div>
        </div>

        <div class="table-section">
            <h2 style="margin-bottom: 15px;">üìã –õ–∏—Å—Ç–∞ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∏</h2>
            <table id="invoiceTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>–§–∏—Ä–º–∞</th>
                        <th>–ë—Ä–æ—ò —Ñ–∞–∫—Ç—É—Ä–∞</th>
                        <th>–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞</th>
                        <th>–í–∫—É–ø–Ω–∞ —Å—É–º–∞</th>
                        <th>–ü–ª–∞—Ç–µ–Ω–æ</th>
                        <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                        <th>–î–∞—Ç—É–º</th>
                        <th>–í–∞–ª—É—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th class="no-print">–ê–∫—Ü–∏–∏</th>
                    </tr>
                </thead>
                <tbody id="invoiceTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal –∑–∞ –µ–¥–∏—Ç—É–≤–∞—ö–µ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è –ò–∑–º–µ–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∞</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editIndex">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editCompanyName">–ò–º–µ –Ω–∞ —Ñ–∏—Ä–º–∞ *</label>
                        <input type="text" id="editCompanyName" required>
                    </div>
                    <div class="form-group">
                        <label for="editInvoiceNumber">–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞ *</label>
                        <input type="text" id="editInvoiceNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="editBankAccount">–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞ *</label>
                        <input type="text" id="editBankAccount" required>
                    </div>
                    <div class="form-group">
                        <label for="editAmount">–°—É–º–∞ (–¥–µ–Ω) *</label>
                        <input type="number" id="editAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="editEntryDate">–î–∞—Ç—É–º –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞ *</label>
                        <input type="date" id="editEntryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editDueDate">–í–∞–ª—É—Ç–∞ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞ *</label>
                        <input type="date" id="editDueDate" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="editNotes">–ó–∞–±–µ–ª–µ—à–∫–∞</label>
                        <textarea id="editNotes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª–Ω–∏ –∑–∞–±–µ–ª–µ—à–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)"></textarea>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">üíæ –ó–∞—á—É–≤–∞—ò –∏–∑–º–µ–Ω–∏</button>
                    <button type="button" class="btn btn-danger" onclick="closeEditModal()">–û—Ç–∫–∞–∂–∏</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal –∑–∞ –ø–ª–∞—ú–∞—ö–∞ -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∞ –ü–ª–∞—ú–∞—ö–∞ –∑–∞ —Ñ–∞–∫—Ç—É—Ä–∞</h2>
                <span class="close" onclick="closePaymentModal()">&times;</span>
            </div>
            <div id="paymentModalContent">
                <div class="payment-info">
                    <div class="payment-info-row">
                        <span>–§–∞–∫—Ç—É—Ä–∞:</span>
                        <strong id="paymentInvoiceNumber"></strong>
                    </div>
                    <div class="payment-info-row">
                        <span>–§–∏—Ä–º–∞:</span>
                        <strong id="paymentCompanyName"></strong>
                    </div>
                    <div class="payment-info-row">
                        <span>–í–∫—É–ø–Ω–∞ —Å—É–º–∞:</span>
                        <strong id="paymentTotalAmount"></strong>
                    </div>
                    <div class="payment-info-row">
                        <span>–ü–ª–∞—Ç–µ–Ω–æ:</span>
                        <strong id="paymentPaidAmount" style="color: #27ae60;"></strong>
                    </div>
                    <div class="payment-info-row">
                        <span>–û—Å—Ç–∞—Ç–æ–∫:</span>
                        <strong id="paymentRemainingAmount" style="color: #e74c3c;"></strong>
                    </div>
                </div>

                <div class="progress-bar" style="margin-top: 20px;">
                    <div class="progress-fill" id="paymentProgress">0%</div>
                </div>

                <h3 style="margin-top: 25px; margin-bottom: 15px;">–î–æ–¥–∞–¥–∏ –Ω–æ–≤–æ –ø–ª–∞—ú–∞—ö–µ</h3>
                <form id="addPaymentForm">
                    <input type="hidden" id="paymentInvoiceIndex">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="paymentAmount">–°—É–º–∞ –Ω–∞ –ø–ª–∞—ú–∞—ö–µ (–¥–µ–Ω) *</label>
                            <input type="number" id="paymentAmount" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="paymentDate">–î–∞—Ç—É–º –Ω–∞ –ø–ª–∞—ú–∞—ö–µ *</label>
                            <input type="date" id="paymentDate" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="paymentNote">–ó–∞–±–µ–ª–µ—à–∫–∞ –∑–∞ –ø–ª–∞—ú–∞—ö–µ—Ç–æ</label>
                            <input type="text" id="paymentNote" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button type="submit" class="btn btn-success">‚úì –î–æ–¥–∞–¥–∏ –ø–ª–∞—ú–∞—ö–µ</button>
                    </div>
                </form>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">–ò—Å—Ç–æ—Ä–∏—ò–∞ –Ω–∞ –ø–ª–∞—ú–∞—ö–∞</h3>
                <div id="paymentsListContainer" class="payments-list"></div>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="closePaymentModal()">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
    </div>

    <!-- Modal –∑–∞ –¥–µ—Ç–∞–ª–µ–Ω –∏–∑–≤–µ—à—Ç–∞—ò -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="reportTitle">üìä –î–µ—Ç–∞–ª–µ–Ω –∏–∑–≤–µ—à—Ç–∞—ò</h2>
                <span class="close" onclick="closeReportModal()">&times;</span>
            </div>
            <div id="reportContent"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="exportReportToCSV()">üì• –ï–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn btn-primary" onclick="printModal()">üñ®Ô∏è –ü—Ä–∏–Ω—Ç–∞—ò</button>
                <button class="btn btn-danger" onclick="closeReportModal()">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
    </div>

    <!-- Modal –∑–∞ –Ω–∞–ø—Ä–µ–¥–µ–Ω –∏–∑–≤–µ—à—Ç–∞—ò -->
    <div id="advancedReportModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>üìä –ù–∞–ø—Ä–µ–¥–µ–Ω –∏–∑–≤–µ—à—Ç–∞—ò</h2>
                <span class="close" onclick="closeAdvancedReport()">&times;</span>
            </div>
            
            <!-- –¢–∞–±–æ–≤–∏ –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ç–∏–ø –∏–∑–≤–µ—à—Ç–∞—ò -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                <button class="btn btn-small btn-info" id="tabSingle" onclick="switchTab('single')" style="flex: 1;">üìÑ –ï–¥–µ–Ω –ø–µ—Ä–∏–æ–¥</button>
                <button class="btn btn-small" id="tabCompare" onclick="switchTab('compare')" style="flex: 1;">üîÑ –°–ø–æ—Ä–µ–¥–±–∞</button>
            </div>

            <!-- –°–µ–∫—Ü–∏—ò–∞ –∑–∞ –µ–¥–µ–Ω –ø–µ—Ä–∏–æ–¥ -->
            <div id="singlePeriodSection">
                <div class="form-grid" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>–¢–∏–ø –Ω–∞ –ø–µ—Ä–∏–æ–¥</label>
                        <select id="periodType" onchange="updatePeriodFields()">
                            <option value="monthly">–ú–µ—Å–µ—á–µ–Ω</option>
                            <option value="quarterly">–ö–≤–∞—Ä—Ç–∞–ª–µ–Ω</option>
                            <option value="yearly">–ì–æ–¥–∏—à–µ–Ω</option>
                            <option value="custom">–°–æ–ø—Å—Ç–≤–µ–Ω –ø–µ—Ä–∏–æ–¥</option>
                        </select>
                    </div>
                    
                    <!-- –ü–æ–ª–∏—ö–∞ –∑–∞ –º–µ—Å–µ—Ü -->
                    <div class="form-group" id="monthFieldGroup">
                        <label>–ú–µ—Å–µ—Ü</label>
                        <select id="selectedMonth">
                            <option value="1">–à–∞–Ω—É–∞—Ä–∏</option>
                            <option value="2">–§–µ–≤—Ä—É–∞—Ä–∏</option>
                            <option value="3">–ú–∞—Ä—Ç</option>
                            <option value="4">–ê–ø—Ä–∏–ª</option>
                            <option value="5">–ú–∞—ò</option>
                            <option value="6">–à—É–Ω–∏</option>
                            <option value="7">–à—É–ª–∏</option>
                            <option value="8">–ê–≤–≥—É—Å—Ç</option>
                            <option value="9">–°–µ–ø—Ç–µ–º–≤—Ä–∏</option>
                            <option value="10">–û–∫—Ç–æ–º–≤—Ä–∏</option>
                            <option value="11">–ù–æ–µ–º–≤—Ä–∏</option>
                            <option value="12">–î–µ–∫–µ–º–≤—Ä–∏</option>
                        </select>
                    </div>

                    <!-- –ü–æ–ª–∏—ö–∞ –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª -->
                    <div class="form-group" id="quarterFieldGroup" style="display: none;">
                        <label>–ö–≤–∞—Ä—Ç–∞–ª</label>
                        <select id="selectedQuarter">
                            <option value="1">Q1 (–à–∞–Ω—É–∞—Ä–∏-–ú–∞—Ä—Ç)</option>
                            <option value="2">Q2 (–ê–ø—Ä–∏–ª-–à—É–Ω–∏)</option>
                            <option value="3">Q3 (–à—É–ª–∏-–°–µ–ø—Ç–µ–º–≤—Ä–∏)</option>
                            <option value="4">Q4 (–û–∫—Ç–æ–º–≤—Ä–∏-–î–µ–∫–µ–º–≤—Ä–∏)</option>
                        </select>
                    </div>

                    <!-- –ü–æ–ª–∏—ö–∞ –∑–∞ —Å–æ–ø—Å—Ç–≤–µ–Ω –ø–µ—Ä–∏–æ–¥ -->
                    <div class="form-group" id="customFromGroup" style="display: none;">
                        <label>–û–¥ –¥–∞—Ç—É–º</label>
                        <input type="date" id="customDateFrom">
                    </div>

                    <div class="form-group" id="customToGroup" style="display: none;">
                        <label>–î–æ –¥–∞—Ç—É–º</label>
                        <input type="date" id="customDateTo">
                    </div>

                    <div class="form-group" id="yearFieldGroup">
                        <label>–ì–æ–¥–∏–Ω–∞</label>
                        <select id="selectedYear"></select>
                    </div>

                    <!-- –§–∏–ª—Ç—Ä–∏ -->
                    <div class="form-group">
                        <label>–§–∏—Ä–º–∞</label>
                        <select id="reportFilterCompany">
                            <option value="">–°–∏—Ç–µ —Ñ–∏—Ä–º–∏</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–°—Ç–∞—Ç—É—Å</label>
                        <select id="reportFilterStatus">
                            <option value="">–°–∏—Ç–µ</option>
                            <option value="paid">–ü–ª–∞—Ç–µ–Ω–∏</option>
                            <option value="partial">–î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∏</option>
                            <option value="unpaid">–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞</label>
                        <select id="reportFilterAccount">
                            <option value="">–°–∏—Ç–µ —Å–º–µ—Ç–∫–∏</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="generateAdvancedReport()" style="width: 100%; padding: 15px; font-size: 18px;">
                    üìä –ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –∏–∑–≤–µ—à—Ç–∞—ò
                </button>
            </div>

            <!-- –°–µ–∫—Ü–∏—ò–∞ –∑–∞ —Å–ø–æ—Ä–µ–¥–±–∞ -->
            <div id="comparePeriodSection" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- –ü–µ—Ä–∏–æ–¥ 1 -->
                    <div style="background: #e8f4f8; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: #667eea;">üìÖ –ü–µ—Ä–∏–æ–¥ 1</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>–¢–∏–ø –Ω–∞ –ø–µ—Ä–∏–æ–¥</label>
                                <select id="periodType1" onchange="updatePeriodFields(1)">
                                    <option value="monthly">–ú–µ—Å–µ—á–µ–Ω</option>
                                    <option value="quarterly">–ö–≤–∞—Ä—Ç–∞–ª–µ–Ω</option>
                                    <option value="yearly">–ì–æ–¥–∏—à–µ–Ω</option>
                                    <option value="custom">–°–æ–ø—Å—Ç–≤–µ–Ω</option>
                                </select>
                            </div>
                            <div class="form-group" id="monthFieldGroup1">
                                <label>–ú–µ—Å–µ—Ü</label>
                                <select id="selectedMonth1">
                                    <option value="1">–à–∞–Ω—É–∞—Ä–∏</option>
                                    <option value="2">–§–µ–≤—Ä—É–∞—Ä–∏</option>
                                    <option value="3">–ú–∞—Ä—Ç</option>
                                    <option value="4">–ê–ø—Ä–∏–ª</option>
                                    <option value="5">–ú–∞—ò</option>
                                    <option value="6">–à—É–Ω–∏</option>
                                    <option value="7">–à—É–ª–∏</option>
                                    <option value="8">–ê–≤–≥—É—Å—Ç</option>
                                    <option value="9">–°–µ–ø—Ç–µ–º–≤—Ä–∏</option>
                                    <option value="10">–û–∫—Ç–æ–º–≤—Ä–∏</option>
                                    <option value="11">–ù–æ–µ–º–≤—Ä–∏</option>
                                    <option value="12">–î–µ–∫–µ–º–≤—Ä–∏</option>
                                </select>
                            </div>
                            <div class="form-group" id="quarterFieldGroup1" style="display: none;">
                                <label>–ö–≤–∞—Ä—Ç–∞–ª</label>
                                <select id="selectedQuarter1">
                                    <option value="1">Q1</option>
                                    <option value="2">Q2</option>
                                    <option value="3">Q3</option>
                                    <option value="4">Q4</option>
                                </select>
                            </div>
                            <div class="form-group" id="customFromGroup1" style="display: none;">
                                <label>–û–¥ –¥–∞—Ç—É–º</label>
                                <input type="date" id="customDateFrom1">
                            </div>
                            <div class="form-group" id="customToGroup1" style="display: none;">
                                <label>–î–æ –¥–∞—Ç—É–º</label>
                                <input type="date" id="customDateTo1">
                            </div>
                            <div class="form-group" id="yearFieldGroup1">
                                <label>–ì–æ–¥–∏–Ω–∞</label>
                                <select id="selectedYear1"></select>
                            </div>
                        </div>
                    </div>

                    <!-- –ü–µ—Ä–∏–æ–¥ 2 -->
                    <div style="background: #ffe8f0; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: #e74c3c;">üìÖ –ü–µ—Ä–∏–æ–¥ 2</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>–¢–∏–ø –Ω–∞ –ø–µ—Ä–∏–æ–¥</label>
                                <select id="periodType2" onchange="updatePeriodFields(2)">
                                    <option value="monthly">–ú–µ—Å–µ—á–µ–Ω</option>
                                    <option value="quarterly">–ö–≤–∞—Ä—Ç–∞–ª–µ–Ω</option>
                                    <option value="yearly">–ì–æ–¥–∏—à–µ–Ω</option>
                                    <option value="custom">–°–æ–ø—Å—Ç–≤–µ–Ω</option>
                                </select>
                            </div>
                            <div class="form-group" id="monthFieldGroup2">
                                <label>–ú–µ—Å–µ—Ü</label>
                                <select id="selectedMonth2">
                                    <option value="1">–à–∞–Ω—É–∞—Ä–∏</option>
                                    <option value="2">–§–µ–≤—Ä—É–∞—Ä–∏</option>
                                    <option value="3">–ú–∞—Ä—Ç</option>
                                    <option value="4">–ê–ø—Ä–∏–ª</option>
                                    <option value="5">–ú–∞—ò</option>
                                    <option value="6">–à—É–Ω–∏</option>
                                    <option value="7">–à—É–ª–∏</option>
                                    <option value="8">–ê–≤–≥—É—Å—Ç</option>
                                    <option value="9">–°–µ–ø—Ç–µ–º–≤—Ä–∏</option>
                                    <option value="10">–û–∫—Ç–æ–º–≤—Ä–∏</option>
                                    <option value="11">–ù–æ–µ–º–≤—Ä–∏</option>
                                    <option value="12">–î–µ–∫–µ–º–≤—Ä–∏</option>
                                </select>
                            </div>
                            <div class="form-group" id="quarterFieldGroup2" style="display: none;">
                                <label>–ö–≤–∞—Ä—Ç–∞–ª</label>
                                <select id="selectedQuarter2">
                                    <option value="1">Q1</option>
                                    <option value="2">Q2</option>
                                    <option value="3">Q3</option>
                                    <option value="4">Q4</option>
                                </select>
                            </div>
                            <div class="form-group" id="customFromGroup2" style="display: none;">
                                <label>–û–¥ –¥–∞—Ç—É–º</label>
                                <input type="date" id="customDateFrom2">
                            </div>
                            <div class="form-group" id="customToGroup2" style="display: none;">
                                <label>–î–æ –¥–∞—Ç—É–º</label>
                                <input type="date" id="customDateTo2">
                            </div>
                            <div class="form-group" id="yearFieldGroup2">
                                <label>–ì–æ–¥–∏–Ω–∞</label>
                                <select id="selectedYear2"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –§–∏–ª—Ç—Ä–∏ –∑–∞ —Å–ø–æ—Ä–µ–¥–±–∞ -->
                <div class="form-grid" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <div class="form-group">
                        <label>–§–∏—Ä–º–∞</label>
                        <select id="reportFilterCompanyCompare">
                            <option value="">–°–∏—Ç–µ —Ñ–∏—Ä–º–∏</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–°—Ç–∞—Ç—É—Å</label>
                        <select id="reportFilterStatusCompare">
                            <option value="">–°–∏—Ç–µ</option>
                            <option value="paid">–ü–ª–∞—Ç–µ–Ω–∏</option>
                            <option value="partial">–î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∏</option>
                            <option value="unpaid">–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞</label>
                        <select id="reportFilterAccountCompare">
                            <option value="">–°–∏—Ç–µ —Å–º–µ—Ç–∫–∏</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="generateComparisonReport()" style="width: 100%; padding: 15px; font-size: 18px; margin-top: 20px;">
                    üîÑ –°–ø–æ—Ä–µ–¥–∏ –ø–µ—Ä–∏–æ–¥–∏
                </button>
            </div>

            <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ–¥ –∏–∑–≤–µ—à—Ç–∞—ò -->
            <div id="advancedReportResults" style="display: none; margin-top: 30px;">
                <hr style="margin: 30px 0; border: none; border-top: 2px solid #eee;">
                <div id="advancedReportContent"></div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="exportAdvancedReportCSV()">üì• –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
                    <button class="btn btn-warning" onclick="exportAdvancedReportJSON()">üíæ –ï–∫—Å–ø–æ—Ä—Ç JSON</button>
                    <button class="btn btn-primary" onclick="printAdvancedReport()">üñ®Ô∏è –ü—Ä–∏–Ω—Ç–∞—ò</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let invoices = [];
        let filteredInvoices = [];
        let currentReportData = null;
        let editingPaymentIndex = null;
        const API_URL = 'https://script.google.com/macros/s/AKfycbwHRZOu-tI-ko8E1mIUHYx5MIhDYixXc26tiKlC7aR0swm_wPLQlB0thjRTn6ZwZrAa/exec';

        // Load from cloud on startup - NEVER sync empty data on load!
        loadFromCloud();

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('mk-MK', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function saveInvoices() {
            // Always save to localStorage as backup
            localStorage.setItem('hotelInvoices', JSON.stringify(invoices));
            // Sync to cloud after saving
            syncToCloud();
        }

        function showSyncStatus(type, message) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.className = `sync-status ${type}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }

        async function loadFromCloud() {
            try {
                showSyncStatus('loading', '‚è≥ –°–µ –≤—á–∏—Ç—É–≤–∞–∞—Ç –ø–æ–¥–∞—Ç–æ—Ü–∏ –æ–¥ Google Sheets...');
                
                const response = await fetch(`${API_URL}?action=getAll&timestamp=${new Date().getTime()}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    invoices = data.invoices || [];
                    
                    // Initialize payments array
                    invoices.forEach(inv => {
                        if (!inv.payments) {
                            inv.payments = [];
                        }
                    });
                    
                    // Save to localStorage as backup
                    localStorage.setItem('hotelInvoices', JSON.stringify(invoices));
                    
                    // Update UI
                    applyFilters();
                    
                    showSyncStatus('success', '‚úì –ü–æ–¥–∞—Ç–æ—Ü–∏—Ç–µ —Å–µ –≤—á–∏—Ç–∞–Ω–∏ –æ–¥ Google Sheets!');
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Load error:', error);
                showSyncStatus('error', '‚úó –ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –ø–æ–≤—Ä–∑–µ —Å–æ Google Sheets. –ö–æ—Ä–∏—Å—Ç–∞–º –ª–æ–∫–∞–ª–Ω–∏ –ø–æ–¥–∞—Ç–æ—Ü–∏.');
                
                // Fallback to localStorage
                const localData = localStorage.getItem('hotelInvoices');
                if (localData) {
                    invoices = JSON.parse(localData);
                    invoices.forEach(inv => {
                        if (!inv.payments) {
                            inv.payments = [];
                        }
                    });
                    applyFilters();
                }
            }
        }

        async function syncToCloud() {
            try {
                // Don't show loading for auto-sync (only for manual)
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save',
                        invoices: invoices
                    })
                });
                
                // Sync is successful (no-cors mode doesn't give us response)
                console.log('Synced to Google Sheets');
                
            } catch (error) {
                console.error('Sync error:', error);
                // Continue working - data is in localStorage
            }
        }

        async function manualSync() {
            try {
                showSyncStatus('loading', '‚è≥ –°–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞ —Å–æ Google Sheets...');
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save',
                        invoices: invoices
                    })
                });
                
                showSyncStatus('success', '‚úì –£—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞–Ω–æ —Å–æ Google Sheets!');
                
                // Reload to confirm
                setTimeout(() => {
                    loadFromCloud();
                }, 1000);
                
            } catch (error) {
                console.error('Manual sync error:', error);
                showSyncStatus('error', '‚úó –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞. –ü–æ–¥–∞—Ç–æ—Ü–∏—Ç–µ —Å–µ –∑–∞—á—É–≤–∞–Ω–∏ –ª–æ–∫–∞–ª–Ω–æ.');
            }
        }

        function calculatePaidAmount(invoice) {
            if (!invoice.payments || invoice.payments.length === 0) {
                return 0;
            }
            return invoice.payments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
        }

        function calculateRemainingAmount(invoice) {
            const total = parseFloat(invoice.amount || 0);
            const paid = calculatePaidAmount(invoice);
            return total - paid;
        }

        function getPaymentStatus(invoice) {
            const remaining = calculateRemainingAmount(invoice);
            const total = parseFloat(invoice.amount || 0);
            
            if (remaining <= 0) {
                return 'paid';
            } else if (remaining < total) {
                return 'partial';
            } else {
                return 'unpaid';
            }
        }

        function updateCompanySummary(companyFilter) {
            const summaryDiv = document.getElementById('companySummary');
            
            if (!companyFilter || companyFilter.trim() === '') {
                summaryDiv.classList.remove('show');
                return;
            }

            // Find all invoices for this company (not just filtered ones)
            const companyInvoices = invoices.filter(inv => 
                inv.companyName && inv.companyName.toLowerCase().includes(companyFilter.toLowerCase())
            );

            if (companyInvoices.length === 0) {
                summaryDiv.classList.remove('show');
                return;
            }

            let totalAmount = 0;
            let paidAmount = 0;
            let remainingAmount = 0;

            companyInvoices.forEach(inv => {
                const invTotal = parseFloat(inv.amount || 0);
                const invPaid = calculatePaidAmount(inv);
                totalAmount += invTotal;
                paidAmount += invPaid;
                remainingAmount += (invTotal - invPaid);
            });

            // Get company name from first matching invoice
            const companyName = companyInvoices[0].companyName;

            document.getElementById('companySummaryName').textContent = companyName;
            document.getElementById('companyInvoiceCount').textContent = companyInvoices.length;
            document.getElementById('companyTotalAmount').textContent = formatCurrency(totalAmount) + ' –¥–µ–Ω';
            document.getElementById('companyPaidAmount').textContent = formatCurrency(paidAmount) + ' –¥–µ–Ω';
            document.getElementById('companyRemainingAmount').textContent = formatCurrency(remainingAmount) + ' –¥–µ–Ω';

            summaryDiv.classList.add('show');
        }

        function showHistory(inputId, historyId, searchTerm, searchField) {
            const historyDiv = document.getElementById(historyId);
            
            if (!searchTerm || searchTerm.length < 2) {
                historyDiv.classList.remove('show');
                return;
            }

            const matchingInvoices = invoices.filter(inv => 
                inv[searchField] && inv[searchField].toLowerCase().includes(searchTerm.toLowerCase())
            );

            // Don't show dropdown if no matching invoices - just hide it
            if (matchingInvoices.length === 0) {
                historyDiv.classList.remove('show');
                return;
            }

            const grouped = {};
            matchingInvoices.forEach(inv => {
                const key = searchField === 'companyName' ? inv.companyName : inv.bankAccount;
                if (!grouped[key]) {
                    grouped[key] = {
                        invoice: inv,
                        count: 0,
                        totalAmount: 0
                    };
                }
                grouped[key].count++;
                grouped[key].totalAmount += parseFloat(inv.amount);
            });

            let html = '';
            Object.values(grouped).forEach(group => {
                const inv = group.invoice;
                html += `
                    <div class="history-item" onclick="fillFromHistory('${inv.companyName.replace(/'/g, "\\'")}', '${inv.bankAccount}')">
                        <div class="history-item-company">
                            ${inv.companyName}
                            <span class="history-badge">${group.count} —Ñ–∞–∫—Ç—É—Ä–∏</span>
                        </div>
                        <div class="history-item-details">
                            <span class="history-item-account">${inv.bankAccount}</span> ‚Ä¢ 
                            <span class="history-item-amount">–í–∫—É–ø–Ω–æ: ${formatCurrency(group.totalAmount)} –¥–µ–Ω</span>
                        </div>
                    </div>
                `;
            });

            historyDiv.innerHTML = html;
            historyDiv.classList.add('show');
        }

        function fillFromHistory(companyName, bankAccount) {
            document.getElementById('companyName').value = companyName;
            document.getElementById('bankAccount').value = bankAccount;
            document.getElementById('companyHistory').classList.remove('show');
            document.getElementById('accountHistory').classList.remove('show');
            document.getElementById('invoiceNumber').focus();
        }

        document.getElementById('companyName').addEventListener('input', function(e) {
            showHistory('companyName', 'companyHistory', e.target.value, 'companyName');
        });

        document.getElementById('bankAccount').addEventListener('input', function(e) {
            showHistory('bankAccount', 'accountHistory', e.target.value, 'bankAccount');
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.form-group')) {
                document.getElementById('companyHistory').classList.remove('show');
                document.getElementById('accountHistory').classList.remove('show');
            }
        });

        function applyFilters() {
            const globalSearch = document.getElementById('globalSearch').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const companyFilter = document.getElementById('filterCompany').value.toLowerCase();
            const accountFilter = document.getElementById('filterAccount').value.toLowerCase();
            const invoiceNumberFilter = document.getElementById('filterInvoiceNumber').value.toLowerCase();
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            filteredInvoices = invoices.filter(invoice => {
                if (globalSearch) {
                    const searchString = `${invoice.invoiceNumber || ''} ${invoice.companyName || ''} ${invoice.bankAccount || ''} ${invoice.amount || ''} ${invoice.entryDate ? formatDate(invoice.entryDate) : ''} ${invoice.dueDate ? formatDate(invoice.dueDate) : ''} ${invoice.notes || ''}`.toLowerCase();
                    if (!searchString.includes(globalSearch)) return false;
                }

                if (statusFilter) {
                    const status = getPaymentStatus(invoice);
                    if (statusFilter !== status) return false;
                }

                if (companyFilter && (!invoice.companyName || !invoice.companyName.toLowerCase().includes(companyFilter))) {
                    return false;
                }

                if (accountFilter && (!invoice.bankAccount || !invoice.bankAccount.toLowerCase().includes(accountFilter))) {
                    return false;
                }

                if (invoiceNumberFilter && (!invoice.invoiceNumber || !invoice.invoiceNumber.toLowerCase().includes(invoiceNumberFilter))) {
                    return false;
                }

                if (dateFrom && invoice.entryDate < dateFrom) return false;
                if (dateTo && invoice.entryDate > dateTo) return false;

                return true;
            });

            // Update company summary if company filter is active
            updateCompanySummary(companyFilter);

            renderInvoices();
        }

        function clearFilters() {
            document.getElementById('globalSearch').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCompany').value = '';
            document.getElementById('filterAccount').value = '';
            document.getElementById('filterInvoiceNumber').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            
            applyFilters();
        }

        function updateSummary() {
            const total = invoices.length;
            const displayed = filteredInvoices.length;
            
            let totalAmount = 0;
            let paidAmount = 0;
            let unpaidAmount = 0;

            filteredInvoices.forEach(inv => {
                const invTotal = parseFloat(inv.amount || 0);
                const invPaid = calculatePaidAmount(inv);
                const invRemaining = invTotal - invPaid;

                totalAmount += invTotal;
                paidAmount += invPaid;
                unpaidAmount += invRemaining;
            });

            document.getElementById('totalInvoices').textContent = total;
            document.getElementById('displayedInvoices').textContent = displayed;
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount) + ' –¥–µ–Ω';
            document.getElementById('paidAmount').textContent = formatCurrency(paidAmount) + ' –¥–µ–Ω';
            document.getElementById('unpaidAmount').textContent = formatCurrency(unpaidAmount) + ' –¥–µ–Ω';
        }

        function renderInvoices() {
            const tbody = document.getElementById('invoiceTableBody');
            tbody.innerHTML = '';

            if (filteredInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 30px; color: #999;">–ù–µ–º–∞ —Ñ–∞–∫—Ç—É—Ä–∏ –∑–∞ –ø—Ä–∏–∫–∞–∂—É–≤–∞—ö–µ</td></tr>';
            } else {
                filteredInvoices.forEach((invoice, displayIndex) => {
                    const actualIndex = invoices.indexOf(invoice);
                    const paidAmount = calculatePaidAmount(invoice);
                    const remainingAmount = calculateRemainingAmount(invoice);
                    const status = getPaymentStatus(invoice);
                    
                    let statusText = '';
                    let statusClass = '';
                    
                    if (status === 'paid') {
                        statusText = '‚úì –ü–ª–∞—Ç–µ–Ω–∞';
                        statusClass = 'status-paid';
                    } else if (status === 'partial') {
                        statusText = '‚è≥ –î–µ–ª—É–º–Ω–æ';
                        statusClass = 'status-partial';
                    } else {
                        statusText = '‚úó –ù–µ–ø–ª–∞—Ç–µ–Ω–∞';
                        statusClass = 'status-unpaid';
                    }

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${displayIndex + 1}</td>
                        <td>${invoice.companyName || ''}</td>
                        <td><strong>${invoice.invoiceNumber || ''}</strong></td>
                        <td>${invoice.bankAccount || ''}</td>
                        <td><strong>${formatCurrency(invoice.amount || 0)}</strong></td>
                        <td style="color: #27ae60;">${formatCurrency(paidAmount)}</td>
                        <td style="color: #e74c3c;"><strong>${formatCurrency(remainingAmount)}</strong></td>
                        <td>${invoice.entryDate ? formatDate(invoice.entryDate) : ''}</td>
                        <td>${invoice.dueDate ? formatDate(invoice.dueDate) : ''}</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td class="actions no-print">
                            <button class="btn btn-info btn-table" onclick="openPaymentModal(${actualIndex})">üí∞</button>
                            <button class="btn btn-warning btn-table" onclick="openEditModal(${actualIndex})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-table" onclick="deleteInvoice(${actualIndex})">üóëÔ∏è</button>
                        </td>
                    `;
                });
            }

            updateSummary();
        }

        function openPaymentModal(index) {
            const invoice = invoices[index];
            const paidAmount = calculatePaidAmount(invoice);
            const remainingAmount = calculateRemainingAmount(invoice);
            const totalAmount = parseFloat(invoice.amount || 0);
            const percentage = totalAmount > 0 ? (paidAmount / totalAmount * 100).toFixed(1) : 0;

            document.getElementById('paymentInvoiceIndex').value = index;
            document.getElementById('paymentInvoiceNumber').textContent = invoice.invoiceNumber || '';
            document.getElementById('paymentCompanyName').textContent = invoice.companyName || '';
            document.getElementById('paymentTotalAmount').textContent = formatCurrency(totalAmount) + ' –¥–µ–Ω';
            document.getElementById('paymentPaidAmount').textContent = formatCurrency(paidAmount) + ' –¥–µ–Ω';
            document.getElementById('paymentRemainingAmount').textContent = formatCurrency(remainingAmount) + ' –¥–µ–Ω';
            
            const progressBar = document.getElementById('paymentProgress');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNote').value = '';
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

            editingPaymentIndex = null;
            renderPaymentsList(invoice.payments || []);

            document.getElementById('paymentModal').style.display = 'block';
        }

        function renderPaymentsList(payments) {
            const container = document.getElementById('paymentsListContainer');
            
            if (!payments || payments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">–°√® —É—à—Ç–µ –Ω–µ–º–∞ –∑–∞–±–µ–ª–µ–∂–∞–Ω–∏ –ø–ª–∞—ú–∞—ö–∞</p>';
                return;
            }

            let html = '';
            payments.forEach((payment, idx) => {
                html += `
                    <div class="payment-item" id="payment-${idx}">
                        <div class="payment-item-info" id="payment-info-${idx}">
                            <div class="payment-item-date">üìÖ ${formatDate(payment.date)}</div>
                            <div class="payment-item-amount">${formatCurrency(payment.amount)} –¥–µ–Ω</div>
                            ${payment.note ? `<div style="color: #666; font-size: 0.9em; margin-top: 5px;">${payment.note}</div>` : ''}
                        </div>
                        <div class="payment-edit-form" id="payment-edit-${idx}">
                            <div class="form-group">
                                <label>–°—É–º–∞ (–¥–µ–Ω)</label>
                                <input type="number" id="edit-amount-${idx}" value="${payment.amount}" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>–î–∞—Ç—É–º</label>
                                <input type="date" id="edit-date-${idx}" value="${payment.date}" required>
                            </div>
                            <div class="form-group">
                                <label>–ó–∞–±–µ–ª–µ—à–∫–∞</label>
                                <input type="text" id="edit-note-${idx}" value="${payment.note || ''}" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ">
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-success btn-small" onclick="savePaymentEdit(${idx})">‚úì –ó–∞—á—É–≤–∞—ò</button>
                                <button class="btn btn-danger btn-small" onclick="cancelPaymentEdit(${idx})">‚úó –û—Ç–∫–∞–∂–∏</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; flex-direction: column;">
                            <button class="btn btn-warning btn-small" id="edit-btn-${idx}" onclick="startEditPayment(${idx})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deletePayment(${idx})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function startEditPayment(paymentIndex) {
            if (editingPaymentIndex !== null && editingPaymentIndex !== paymentIndex) {
                cancelPaymentEdit(editingPaymentIndex);
            }

            editingPaymentIndex = paymentIndex;
            
            const paymentItem = document.getElementById(`payment-${paymentIndex}`);
            const infoDiv = document.getElementById(`payment-info-${paymentIndex}`);
            const editForm = document.getElementById(`payment-edit-${paymentIndex}`);
            const editBtn = document.getElementById(`edit-btn-${paymentIndex}`);

            paymentItem.classList.add('editing');
            infoDiv.style.display = 'none';
            editForm.classList.add('active');
            editBtn.style.display = 'none';
        }

        function cancelPaymentEdit(paymentIndex) {
            const paymentItem = document.getElementById(`payment-${paymentIndex}`);
            const infoDiv = document.getElementById(`payment-info-${paymentIndex}`);
            const editForm = document.getElementById(`payment-edit-${paymentIndex}`);
            const editBtn = document.getElementById(`edit-btn-${paymentIndex}`);

            if (paymentItem && infoDiv && editForm && editBtn) {
                paymentItem.classList.remove('editing');
                infoDiv.style.display = 'block';
                editForm.classList.remove('active');
                editBtn.style.display = 'block';
            }

            editingPaymentIndex = null;
        }

        function savePaymentEdit(paymentIndex) {
            const invoiceIndex = parseInt(document.getElementById('paymentInvoiceIndex').value);
            const invoice = invoices[invoiceIndex];
            
            const newAmount = parseFloat(document.getElementById(`edit-amount-${paymentIndex}`).value);
            const newDate = document.getElementById(`edit-date-${paymentIndex}`).value;
            const newNote = document.getElementById(`edit-note-${paymentIndex}`).value;

            if (newAmount <= 0) {
                alert('–°—É–º–∞—Ç–∞ –º–æ—Ä–∞ –¥–∞ –±–∏–¥–µ –ø–æ–≥–æ–ª–µ–º–∞ –æ–¥ 0!');
                return;
            }

            const currentPaymentAmount = invoice.payments[paymentIndex].amount;
            const totalPaid = calculatePaidAmount(invoice) - currentPaymentAmount;
            const totalAmount = parseFloat(invoice.amount || 0);
            const available = totalAmount - totalPaid;

            if (newAmount > available) {
                alert(`–°—É–º–∞—Ç–∞ (${formatCurrency(newAmount)} –¥–µ–Ω) –µ –ø–æ–≥–æ–ª–µ–º–∞ –æ–¥ –¥–æ—Å—Ç–∞–ø–Ω–∏–æ—Ç –æ—Å—Ç–∞—Ç–æ–∫ (${formatCurrency(available)} –¥–µ–Ω)!`);
                return;
            }

            invoice.payments[paymentIndex] = {
                amount: newAmount,
                date: newDate,
                note: newNote
            };

            saveInvoices();
            openPaymentModal(invoiceIndex);
            applyFilters();
        }

        function deletePayment(paymentIndex) {
            if (!confirm('–î–∞–ª–∏ —Å—Ç–µ —Å–∏–≥—É—Ä–Ω–∏ –¥–µ–∫–∞ —Å–∞–∫–∞—Ç–µ –¥–∞ –≥–æ –∏–∑–±—Ä–∏—à–µ—Ç–µ –æ–≤–∞ –ø–ª–∞—ú–∞—ö–µ?')) {
                return;
            }

            const invoiceIndex = parseInt(document.getElementById('paymentInvoiceIndex').value);
            invoices[invoiceIndex].payments.splice(paymentIndex, 1);
            saveInvoices();
            
            openPaymentModal(invoiceIndex);
            applyFilters();
        }

        document.getElementById('addPaymentForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const invoiceIndex = parseInt(document.getElementById('paymentInvoiceIndex').value);
            const invoice = invoices[invoiceIndex];
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const remainingAmount = calculateRemainingAmount(invoice);

            if (paymentAmount > remainingAmount) {
                alert(`–°—É–º–∞—Ç–∞ –Ω–∞ –ø–ª–∞—ú–∞—ö–µ—Ç–æ (${formatCurrency(paymentAmount)} –¥–µ–Ω) –µ –ø–æ–≥–æ–ª–µ–º–∞ –æ–¥ –æ—Å—Ç–∞—Ç–æ–∫–æ—Ç (${formatCurrency(remainingAmount)} –¥–µ–Ω)!`);
                return;
            }

            if (paymentAmount <= 0) {
                alert('–°—É–º–∞—Ç–∞ –Ω–∞ –ø–ª–∞—ú–∞—ö–µ—Ç–æ –º–æ—Ä–∞ –¥–∞ –±–∏–¥–µ –ø–æ–≥–æ–ª–µ–º–∞ –æ–¥ 0!');
                return;
            }

            const payment = {
                amount: paymentAmount,
                date: document.getElementById('paymentDate').value,
                note: document.getElementById('paymentNote').value
            };

            if (!invoice.payments) {
                invoice.payments = [];
            }

            invoice.payments.push(payment);
            saveInvoices();
            
            openPaymentModal(invoiceIndex);
            applyFilters();
        });

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            editingPaymentIndex = null;
        }

        function showAllInvoices() {
            clearFilters();
        }

        function showDetailReport(type) {
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });

            let title = '';
            let dataToShow = [];
            
            if (type === 'paid') {
                title = '‚úì –ü–ª–∞—Ç–µ–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∏';
                dataToShow = filteredInvoices.filter(inv => getPaymentStatus(inv) === 'paid');
                document.getElementById('cardPaid').classList.add('active');
            } else if (type === 'unpaid') {
                title = '‚úó –ù–µ–ø–ª–∞—Ç–µ–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∏';
                dataToShow = filteredInvoices.filter(inv => getPaymentStatus(inv) === 'unpaid');
                document.getElementById('cardUnpaid').classList.add('active');
            } else if (type === 'total') {
                title = 'üí∞ –í–∫—É–ø–Ω–∞ –≤—Ä–µ–¥–Ω–æ—Å—Ç - –°–∏—Ç–µ —Ñ–∞–∫—Ç—É—Ä–∏';
                dataToShow = filteredInvoices;
                document.getElementById('cardTotalAmount').classList.add('active');
            } else if (type === 'displayed') {
                title = 'üìã –ü—Ä–∏–∫–∞–∂–∞–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∏';
                dataToShow = filteredInvoices;
                document.getElementById('cardDisplayed').classList.add('active');
            }

            currentReportData = dataToShow;
            
            let totalAmount = 0;
            let paidAmount = 0;
            let unpaidAmount = 0;

            dataToShow.forEach(inv => {
                const invTotal = parseFloat(inv.amount || 0);
                const invPaid = calculatePaidAmount(inv);
                totalAmount += invTotal;
                paidAmount += invPaid;
                unpaidAmount += (invTotal - invPaid);
            });

            let html = `
                <div class="detail-table">
                    <div class="detail-row">
                        <span class="detail-label">–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∏:</span>
                        <span class="detail-value">${dataToShow.length}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–í–∫—É–ø–Ω–∞ —Å—É–º–∞:</span>
                        <span class="detail-value">${formatCurrency(totalAmount)} –¥–µ–Ω</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–ü–ª–∞—Ç–µ–Ω–æ:</span>
                        <span class="detail-value" style="color: #27ae60;">${formatCurrency(paidAmount)} –¥–µ–Ω</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">–û—Å—Ç–∞—Ç–æ–∫:</span>
                        <span class="detail-value" style="color: #e74c3c;">${formatCurrency(unpaidAmount)} –¥–µ–Ω</span>
                    </div>
                </div>
                <h3 style="margin-top: 25px; margin-bottom: 15px;">–õ–∏—Å—Ç–∞ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∏:</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 10px; text-align: left;">#</th>
                            <th style="padding: 10px; text-align: left;">–§–∏—Ä–º–∞</th>
                            <th style="padding: 10px; text-align: left;">–ë—Ä–æ—ò</th>
                            <th style="padding: 10px; text-align: left;">–í–∫—É–ø–Ω–æ</th>
                            <th style="padding: 10px; text-align: left;">–ü–ª–∞—Ç–µ–Ω–æ</th>
                            <th style="padding: 10px; text-align: left;">–û—Å—Ç–∞—Ç–æ–∫</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            dataToShow.forEach((inv, idx) => {
                const invPaid = calculatePaidAmount(inv);
                const invRemaining = parseFloat(inv.amount || 0) - invPaid;
                html += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">${idx + 1}</td>
                        <td style="padding: 10px;">${inv.companyName || ''}</td>
                        <td style="padding: 10px;"><strong>${inv.invoiceNumber || ''}</strong></td>
                        <td style="padding: 10px;">${formatCurrency(inv.amount || 0)} –¥–µ–Ω</td>
                        <td style="padding: 10px; color: #27ae60;">${formatCurrency(invPaid)} –¥–µ–Ω</td>
                        <td style="padding: 10px; color: #e74c3c;"><strong>${formatCurrency(invRemaining)} –¥–µ–Ω</strong></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';

            document.getElementById('reportTitle').textContent = title;
            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportModal').style.display = 'block';
        }

        function generateMonthlyReport() {
            const monthlyData = {};
            
            filteredInvoices.forEach(inv => {
                if (inv.entryDate) {
                    const date = new Date(inv.entryDate);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            month: monthKey,
                            invoices: [],
                            total: 0,
                            paid: 0,
                            unpaid: 0
                        };
                    }
                    
                    const invTotal = parseFloat(inv.amount || 0);
                    const invPaid = calculatePaidAmount(inv);
                    
                    monthlyData[monthKey].invoices.push(inv);
                    monthlyData[monthKey].total += invTotal;
                    monthlyData[monthKey].paid += invPaid;
                    monthlyData[monthKey].unpaid += (invTotal - invPaid);
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            
            let html = '<h3 style="margin-bottom: 20px;">üìÖ –ú–µ—Å–µ—á–µ–Ω –∏–∑–≤–µ—à—Ç–∞—ò</h3>';
            
            sortedMonths.forEach(monthKey => {
                const data = monthlyData[monthKey];
                const [year, month] = monthKey.split('-');
                const monthNames = ['–à–∞–Ω—É–∞—Ä–∏', '–§–µ–≤—Ä—É–∞—Ä–∏', '–ú–∞—Ä—Ç', '–ê–ø—Ä–∏–ª', '–ú–∞—ò', '–à—É–Ω–∏', 
                                   '–à—É–ª–∏', '–ê–≤–≥—É—Å—Ç', '–°–µ–ø—Ç–µ–º–≤—Ä–∏', '–û–∫—Ç–æ–º–≤—Ä–∏', '–ù–æ–µ–º–≤—Ä–∏', '–î–µ–∫–µ–º–≤—Ä–∏'];
                const monthName = monthNames[parseInt(month) - 1];
                
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">${monthName} ${year}</h4>
                        <div class="detail-table">
                            <div class="detail-row">
                                <span class="detail-label">–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∏:</span>
                                <span class="detail-value">${data.invoices.length}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">–í–∫—É–ø–Ω–∞ –≤—Ä–µ–¥–Ω–æ—Å—Ç:</span>
                                <span class="detail-value">${formatCurrency(data.total)} –¥–µ–Ω</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">–ü–ª–∞—Ç–µ–Ω–∏:</span>
                                <span class="detail-value" style="color: #27ae60;">${formatCurrency(data.paid)} –¥–µ–Ω</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">–ù–µ–ø–ª–∞—Ç–µ–Ω–∏:</span>
                                <span class="detail-value" style="color: #e74c3c;">${formatCurrency(data.unpaid)} –¥–µ–Ω</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            currentReportData = filteredInvoices;
            document.getElementById('reportTitle').textContent = 'üìÖ –ú–µ—Å–µ—á–µ–Ω –∏–∑–≤–µ—à—Ç–∞—ò';
            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportModal').style.display = 'block';
        }

        // ========== –ù–ê–ü–†–ï–î–ï–ù –ò–ó–í–ï–®–¢–ê–à –°–ò–°–¢–ï–ú ==========
        
        let currentAdvancedReportData = null;
        let currentTab = 'single';

        function openAdvancedReport() {
            populateYearDropdowns();
            populateReportFilters();
            
            const now = new Date();
            document.getElementById('selectedMonth').value = (now.getMonth() + 1).toString();
            document.getElementById('selectedYear').value = now.getFullYear().toString();
            
            document.getElementById('advancedReportResults').style.display = 'none';
            document.getElementById('advancedReportModal').style.display = 'block';
            switchTab('single');
        }

        function closeAdvancedReport() {
            document.getElementById('advancedReportModal').style.display = 'none';
            currentAdvancedReportData = null;
        }

        function switchTab(tab) {
            currentTab = tab;
            
            const singleSection = document.getElementById('singlePeriodSection');
            const compareSection = document.getElementById('comparePeriodSection');
            const tabSingle = document.getElementById('tabSingle');
            const tabCompare = document.getElementById('tabCompare');
            
            if (tab === 'single') {
                singleSection.style.display = 'block';
                compareSection.style.display = 'none';
                tabSingle.classList.add('btn-info');
                tabCompare.classList.remove('btn-info');
            } else {
                singleSection.style.display = 'none';
                compareSection.style.display = 'block';
                tabSingle.classList.remove('btn-info');
                tabCompare.classList.add('btn-info');
            }
            
            document.getElementById('advancedReportResults').style.display = 'none';
        }

        function populateYearDropdowns() {
            const currentYear = new Date().getFullYear();
            const years = [];
            for (let y = currentYear - 5; y <= currentYear + 1; y++) {
                years.push(y);
            }
            
            const yearSelects = ['selectedYear', 'selectedYear1', 'selectedYear2'];
            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) option.selected = true;
                    select.appendChild(option);
                });
            });
        }

        function populateReportFilters() {
            const companies = [...new Set(invoices.map(inv => inv.companyName).filter(Boolean))].sort();
            const accounts = [...new Set(invoices.map(inv => inv.bankAccount).filter(Boolean))].sort();
            
            const companySelects = ['reportFilterCompany', 'reportFilterCompanyCompare'];
            companySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">–°–∏—Ç–µ —Ñ–∏—Ä–º–∏</option>';
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    select.appendChild(option);
                });
            });
            
            const accountSelects = ['reportFilterAccount', 'reportFilterAccountCompare'];
            accountSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">–°–∏—Ç–µ —Å–º–µ—Ç–∫–∏</option>';
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account;
                    option.textContent = account;
                    select.appendChild(option);
                });
            });
        }

        function updatePeriodFields(periodNum) {
            const suffix = periodNum ? periodNum.toString() : '';
            const periodType = document.getElementById('periodType' + suffix).value;
            
            const monthGroup = document.getElementById('monthFieldGroup' + suffix);
            const quarterGroup = document.getElementById('quarterFieldGroup' + suffix);
            const customFromGroup = document.getElementById('customFromGroup' + suffix);
            const customToGroup = document.getElementById('customToGroup' + suffix);
            const yearGroup = document.getElementById('yearFieldGroup' + suffix);
            
            if (monthGroup) monthGroup.style.display = 'none';
            if (quarterGroup) quarterGroup.style.display = 'none';
            if (customFromGroup) customFromGroup.style.display = 'none';
            if (customToGroup) customToGroup.style.display = 'none';
            
            if (periodType === 'monthly') {
                if (monthGroup) monthGroup.style.display = 'block';
                if (yearGroup) yearGroup.style.display = 'block';
            } else if (periodType === 'quarterly') {
                if (quarterGroup) quarterGroup.style.display = 'block';
                if (yearGroup) yearGroup.style.display = 'block';
            } else if (periodType === 'yearly') {
                if (yearGroup) yearGroup.style.display = 'block';
            } else if (periodType === 'custom') {
                if (customFromGroup) customFromGroup.style.display = 'block';
                if (customToGroup) customToGroup.style.display = 'block';
            }
        }

        function getPeriodDateRange(periodType, year, month, quarter, customFrom, customTo) {
            let startDate, endDate;
            
            if (periodType === 'monthly') {
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0);
            } else if (periodType === 'quarterly') {
                const quarterStartMonth = (quarter - 1) * 3;
                startDate = new Date(year, quarterStartMonth, 1);
                endDate = new Date(year, quarterStartMonth + 3, 0);
            } else if (periodType === 'yearly') {
                startDate = new Date(year, 0, 1);
                endDate = new Date(year, 11, 31);
            } else if (periodType === 'custom') {
                startDate = new Date(customFrom);
                endDate = new Date(customTo);
            }
            
            return { startDate, endDate };
        }

        function filterInvoicesByPeriod(startDate, endDate, companyFilter, statusFilter, accountFilter) {
            return invoices.filter(inv => {
                const invDate = new Date(inv.entryDate);
                
                if (invDate < startDate || invDate > endDate) return false;
                
                if (companyFilter && inv.companyName !== companyFilter) return false;
                
                if (accountFilter && inv.bankAccount !== accountFilter) return false;
                
                if (statusFilter) {
                    const status = getPaymentStatus(inv);
                    if (status !== statusFilter) return false;
                }
                
                return true;
            });
        }

        function generateAdvancedReport() {
            const periodType = document.getElementById('periodType').value;
            const year = parseInt(document.getElementById('selectedYear').value);
            const month = parseInt(document.getElementById('selectedMonth').value);
            const quarter = parseInt(document.getElementById('selectedQuarter').value);
            const customFrom = document.getElementById('customDateFrom').value;
            const customTo = document.getElementById('customDateTo').value;
            
            const companyFilter = document.getElementById('reportFilterCompany').value;
            const statusFilter = document.getElementById('reportFilterStatus').value;
            const accountFilter = document.getElementById('reportFilterAccount').value;
            
            if (periodType === 'custom' && (!customFrom || !customTo)) {
                alert('–í–µ –º–æ–ª–∏–º–µ –≤–Ω–µ—Å–µ—Ç–µ –≥–æ –ø–µ—Ä–∏–æ–¥–æ—Ç (–æ–¥-–¥–æ –¥–∞—Ç—É–º)!');
                return;
            }
            
            const { startDate, endDate } = getPeriodDateRange(periodType, year, month, quarter, customFrom, customTo);
            const filteredData = filterInvoicesByPeriod(startDate, endDate, companyFilter, statusFilter, accountFilter);
            
            currentAdvancedReportData = {
                type: 'single',
                periodType: periodType,
                startDate: startDate,
                endDate: endDate,
                data: filteredData,
                filters: { company: companyFilter, status: statusFilter, account: accountFilter }
            };
            
            displayAdvancedReport();
        }

        function generateComparisonReport() {
            const periodType1 = document.getElementById('periodType1').value;
            const year1 = parseInt(document.getElementById('selectedYear1').value);
            const month1 = parseInt(document.getElementById('selectedMonth1').value);
            const quarter1 = parseInt(document.getElementById('selectedQuarter1').value);
            const customFrom1 = document.getElementById('customDateFrom1').value;
            const customTo1 = document.getElementById('customDateTo1').value;
            
            const periodType2 = document.getElementById('periodType2').value;
            const year2 = parseInt(document.getElementById('selectedYear2').value);
            const month2 = parseInt(document.getElementById('selectedMonth2').value);
            const quarter2 = parseInt(document.getElementById('selectedQuarter2').value);
            const customFrom2 = document.getElementById('customDateFrom2').value;
            const customTo2 = document.getElementById('customDateTo2').value;
            
            const companyFilter = document.getElementById('reportFilterCompanyCompare').value;
            const statusFilter = document.getElementById('reportFilterStatusCompare').value;
            const accountFilter = document.getElementById('reportFilterAccountCompare').value;
            
            if (periodType1 === 'custom' && (!customFrom1 || !customTo1)) {
                alert('–í–µ –º–æ–ª–∏–º–µ –≤–Ω–µ—Å–µ—Ç–µ –≥–æ –ü–µ—Ä–∏–æ–¥ 1 (–æ–¥-–¥–æ –¥–∞—Ç—É–º)!');
                return;
            }
            if (periodType2 === 'custom' && (!customFrom2 || !customTo2)) {
                alert('–í–µ –º–æ–ª–∏–º–µ –≤–Ω–µ—Å–µ—Ç–µ –≥–æ –ü–µ—Ä–∏–æ–¥ 2 (–æ–¥-–¥–æ –¥–∞—Ç—É–º)!');
                return;
            }
            
            const period1 = getPeriodDateRange(periodType1, year1, month1, quarter1, customFrom1, customTo1);
            const period2 = getPeriodDateRange(periodType2, year2, month2, quarter2, customFrom2, customTo2);
            
            const data1 = filterInvoicesByPeriod(period1.startDate, period1.endDate, companyFilter, statusFilter, accountFilter);
            const data2 = filterInvoicesByPeriod(period2.startDate, period2.endDate, companyFilter, statusFilter, accountFilter);
            
            currentAdvancedReportData = {
                type: 'compare',
                period1: { ...period1, data: data1, periodType: periodType1 },
                period2: { ...period2, data: data2, periodType: periodType2 },
                filters: { company: companyFilter, status: statusFilter, account: accountFilter }
            };
            
            displayComparisonReport();
        }

        function displayAdvancedReport() {
            const data = currentAdvancedReportData.data;
            const monthNames = ['–à–∞–Ω—É–∞—Ä–∏', '–§–µ–≤—Ä—É–∞—Ä–∏', '–ú–∞—Ä—Ç', '–ê–ø—Ä–∏–ª', '–ú–∞—ò', '–à—É–Ω–∏', 
                               '–à—É–ª–∏', '–ê–≤–≥—É—Å—Ç', '–°–µ–ø—Ç–µ–º–≤—Ä–∏', '–û–∫—Ç–æ–º–≤—Ä–∏', '–ù–æ–µ–º–≤—Ä–∏', '–î–µ–∫–µ–º–≤—Ä–∏'];
            
            const monthlyBreakdown = {};
            let totalInvoices = 0;
            let totalAmount = 0;
            let totalPaid = 0;
            let totalRemaining = 0;
            
            data.forEach(inv => {
                const invDate = new Date(inv.entryDate);
                const monthKey = `${invDate.getFullYear()}-${String(invDate.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyBreakdown[monthKey]) {
                    monthlyBreakdown[monthKey] = {
                        invoices: 0,
                        total: 0,
                        paid: 0,
                        remaining: 0
                    };
                }
                
                const invTotal = parseFloat(inv.amount || 0);
                const invPaid = calculatePaidAmount(inv);
                const invRemaining = invTotal - invPaid;
                
                monthlyBreakdown[monthKey].invoices++;
                monthlyBreakdown[monthKey].total += invTotal;
                monthlyBreakdown[monthKey].paid += invPaid;
                monthlyBreakdown[monthKey].remaining += invRemaining;
                
                totalInvoices++;
                totalAmount += invTotal;
                totalPaid += invPaid;
                totalRemaining += invRemaining;
            });
            
            let html = `
                <h3 style="color: #667eea; margin-bottom: 20px;">üìä –ò–∑–≤–µ—à—Ç–∞—ò –∑–∞ –ø–µ—Ä–∏–æ–¥: ${formatDate(currentAdvancedReportData.startDate.toISOString().split('T')[0])} - ${formatDate(currentAdvancedReportData.endDate.toISOString().split('T')[0])}</h3>
            `;
            
            if (currentAdvancedReportData.filters.company || currentAdvancedReportData.filters.status || currentAdvancedReportData.filters.account) {
                html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
                html += '<strong>üîç –ê–∫—Ç–∏–≤–Ω–∏ —Ñ–∏–ª—Ç—Ä–∏:</strong> ';
                const filters = [];
                if (currentAdvancedReportData.filters.company) filters.push(`–§–∏—Ä–º–∞: ${currentAdvancedReportData.filters.company}`);
                if (currentAdvancedReportData.filters.status) {
                    const statusText = currentAdvancedReportData.filters.status === 'paid' ? '–ü–ª–∞—Ç–µ–Ω–∏' : 
                                      currentAdvancedReportData.filters.status === 'partial' ? '–î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∏' : '–ù–µ–ø–ª–∞—Ç–µ–Ω–∏';
                    filters.push(`–°—Ç–∞—Ç—É—Å: ${statusText}`);
                }
                if (currentAdvancedReportData.filters.account) filters.push(`–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞: ${currentAdvancedReportData.filters.account}`);
                html += filters.join(' | ');
                html += '</div>';
            }
            
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">–í–∫—É–ø–Ω–æ —Ñ–∞–∫—Ç—É—Ä–∏</div>
                        <div style="font-size: 2em; font-weight: 700;">${totalInvoices}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">–í–∫—É–ø–Ω–∞ –≤—Ä–µ–¥–Ω–æ—Å—Ç</div>
                        <div style="font-size: 1.5em; font-weight: 700;">${formatCurrency(totalAmount)} –¥–µ–Ω</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">–ü–ª–∞—Ç–µ–Ω–æ</div>
                        <div style="font-size: 1.5em; font-weight: 700;">${formatCurrency(totalPaid)} –¥–µ–Ω</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">–û—Å—Ç–∞—Ç–æ–∫</div>
                        <div style="font-size: 1.5em; font-weight: 700;">${formatCurrency(totalRemaining)} –¥–µ–Ω</div>
                    </div>
                </div>
            `;
            
            if (Object.keys(monthlyBreakdown).length > 0) {
                html += '<h4 style="margin-top: 30px; margin-bottom: 15px;">üìÖ –î–µ—Ç–∞–ª–∏ –ø–æ –º–µ—Å–µ—Ü–∏:</h4>';
                
                const sortedMonths = Object.keys(monthlyBreakdown).sort();
                sortedMonths.forEach(monthKey => {
                    const [year, monthNum] = monthKey.split('-');
                    const monthName = monthNames[parseInt(monthNum) - 1];
                    const breakdown = monthlyBreakdown[monthKey];
                    
                    html += `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                            <h5 style="color: #667eea; margin-bottom: 15px;">${monthName} ${year}</h5>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                <div>
                                    <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">–§–∞–∫—Ç—É—Ä–∏</div>
                                    <div style="font-size: 1.3em; font-weight: 600;">${breakdown.invoices}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">–í–∫—É–ø–Ω–æ</div>
                                    <div style="font-size: 1.3em; font-weight: 600;">${formatCurrency(breakdown.total)} –¥–µ–Ω</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">–ü–ª–∞—Ç–µ–Ω–æ</div>
                                    <div style="font-size: 1.3em; font-weight: 600; color: #27ae60;">${formatCurrency(breakdown.paid)} –¥–µ–Ω</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">–û—Å—Ç–∞—Ç–æ–∫</div>
                                    <div style="font-size: 1.3em; font-weight: 600; color: #e74c3c;">${formatCurrency(breakdown.remaining)} –¥–µ–Ω</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (data.length > 0) {
                html += `
                    <h4 style="margin-top: 30px; margin-bottom: 15px;">üìã –î–µ—Ç–∞–ª–Ω–∞ –ª–∏—Å—Ç–∞ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∏:</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 10px; text-align: left;">#</th>
                                <th style="padding: 10px; text-align: left;">–§–∏—Ä–º–∞</th>
                                <th style="padding: 10px; text-align: left;">–ë—Ä–æ—ò</th>
                                <th style="padding: 10px; text-align: right;">–í–∫—É–ø–Ω–æ</th>
                                <th style="padding: 10px; text-align: right;">–ü–ª–∞—Ç–µ–Ω–æ</th>
                                <th style="padding: 10px; text-align: right;">–û—Å—Ç–∞—Ç–æ–∫</th>
                                <th style="padding: 10px; text-align: center;">–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.forEach((inv, idx) => {
                    const paidAmount = calculatePaidAmount(inv);
                    const remaining = parseFloat(inv.amount || 0) - paidAmount;
                    const status = getPaymentStatus(inv);
                    const statusText = status === 'paid' ? '–ü–ª–∞—Ç–µ–Ω–∞' : (status === 'partial' ? '–î–µ–ª—É–º–Ω–æ' : '–ù–µ–ø–ª–∞—Ç–µ–Ω–∞');
                    const statusColor = status === 'paid' ? '#27ae60' : (status === 'partial' ? '#f39c12' : '#e74c3c');
                    
                    html += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;">${idx + 1}</td>
                            <td style="padding: 10px;">${inv.companyName || ''}</td>
                            <td style="padding: 10px;">${inv.invoiceNumber || ''}</td>
                            <td style="padding: 10px; text-align: right;">${formatCurrency(inv.amount || 0)}</td>
                            <td style="padding: 10px; text-align: right; color: #27ae60;">${formatCurrency(paidAmount)}</td>
                            <td style="padding: 10px; text-align: right; color: #e74c3c;">${formatCurrency(remaining)}</td>
                            <td style="padding: 10px; text-align: center;">
                                <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            } else {
                html += '<p style="text-align: center; padding: 40px; color: #999; font-style: italic;">–ù–µ–º–∞ –ø—Ä–æ–Ω–∞—ò–¥–µ–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∏ –∑–∞ –∏–∑–±—Ä–∞–Ω–∏–æ—Ç –ø–µ—Ä–∏–æ–¥ –∏ —Ñ–∏–ª—Ç—Ä–∏.</p>';
            }
            
            document.getElementById('advancedReportContent').innerHTML = html;
            document.getElementById('advancedReportResults').style.display = 'block';
        }

        function displayComparisonReport() {
            const period1 = currentAdvancedReportData.period1;
            const period2 = currentAdvancedReportData.period2;
            
            function calculateTotals(data) {
                let invoices = 0, total = 0, paid = 0, remaining = 0;
                data.forEach(inv => {
                    const invTotal = parseFloat(inv.amount || 0);
                    const invPaid = calculatePaidAmount(inv);
                    invoices++;
                    total += invTotal;
                    paid += invPaid;
                    remaining += (invTotal - invPaid);
                });
                return { invoices, total, paid, remaining };
            }
            
            const totals1 = calculateTotals(period1.data);
            const totals2 = calculateTotals(period2.data);
            
            const diffInvoices = totals2.invoices - totals1.invoices;
            const diffTotal = totals2.total - totals1.total;
            const diffPaid = totals2.paid - totals1.paid;
            const diffRemaining = totals2.remaining - totals1.remaining;
            
            const pctInvoices = totals1.invoices > 0 ? ((diffInvoices / totals1.invoices) * 100).toFixed(1) : 'N/A';
            const pctTotal = totals1.total > 0 ? ((diffTotal / totals1.total) * 100).toFixed(1) : 'N/A';
            const pctPaid = totals1.paid > 0 ? ((diffPaid / totals1.paid) * 100).toFixed(1) : 'N/A';
            const pctRemaining = totals1.remaining > 0 ? ((diffRemaining / totals1.remaining) * 100).toFixed(1) : 'N/A';
            
            let html = `
                <h3 style="color: #667eea; margin-bottom: 20px;">üîÑ –°–ø–æ—Ä–µ–¥–±–∞ –Ω–∞ –ø–µ—Ä–∏–æ–¥–∏</h3>
            `;
            
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: #e8f4f8; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üìÖ –ü–µ—Ä–∏–æ–¥ 1</h4>
                        <p>${formatDate(period1.startDate.toISOString().split('T')[0])} - ${formatDate(period1.endDate.toISOString().split('T')[0])}</p>
                    </div>
                    <div style="background: #ffe8f0; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #e74c3c; margin-bottom: 10px;">üìÖ –ü–µ—Ä–∏–æ–¥ 2</h4>
                        <p>${formatDate(period2.startDate.toISOString().split('T')[0])} - ${formatDate(period2.endDate.toISOString().split('T')[0])}</p>
                    </div>
                </div>
            `;
            
            html += `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 12px; text-align: left;">–ú–µ—Ç—Ä–∏–∫–∞</th>
                            <th style="padding: 12px; text-align: right;">–ü–µ—Ä–∏–æ–¥ 1</th>
                            <th style="padding: 12px; text-align: right;">–ü–µ—Ä–∏–æ–¥ 2</th>
                            <th style="padding: 12px; text-align: right;">–†–∞–∑–ª–∏–∫–∞</th>
                            <th style="padding: 12px; text-align: right;">–ü—Ä–æ–º–µ–Ω–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: 600;">–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∏</td>
                            <td style="padding: 12px; text-align: right;">${totals1.invoices}</td>
                            <td style="padding: 12px; text-align: right;">${totals2.invoices}</td>
                            <td style="padding: 12px; text-align: right; color: ${diffInvoices >= 0 ? '#27ae60' : '#e74c3c'};">
                                ${diffInvoices >= 0 ? '+' : ''}${diffInvoices}
                            </td>
                            <td style="padding: 12px; text-align: right; color: ${diffInvoices >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: 600;">
                                ${pctInvoices !== 'N/A' ? (pctInvoices >= 0 ? '+' : '') + pctInvoices + '%' : 'N/A'}
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: 600;">–í–∫—É–ø–Ω–∞ –≤—Ä–µ–¥–Ω–æ—Å—Ç</td>
                            <td style="padding: 12px; text-align: right;">${formatCurrency(totals1.total)} –¥–µ–Ω</td>
                            <td style="padding: 12px; text-align: right;">${formatCurrency(totals2.total)} –¥–µ–Ω</td>
                            <td style="padding: 12px; text-align: right; color: ${diffTotal >= 0 ? '#27ae60' : '#e74c3c'};">
                                ${diffTotal >= 0 ? '+' : ''}${formatCurrency(diffTotal)} –¥–µ–Ω
                            </td>
                            <td style="padding: 12px; text-align: right; color: ${diffTotal >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: 600;">
                                ${pctTotal !== 'N/A' ? (pctTotal >= 0 ? '+' : '') + pctTotal + '%' : 'N/A'}
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: 600;">–ü–ª–∞—Ç–µ–Ω–æ</td>
                            <td style="padding: 12px; text-align: right;">${formatCurrency(totals1.paid)} –¥–µ–Ω</td>
                            <td style="padding: 12px; text-align: right;">${formatCurrency(totals2.paid)} –¥–µ–Ω</td>
                            <td style="padding: 12px; text-align: right; color: ${diffPaid >= 0 ? '#27ae60' : '#e74c3c'};">
                                ${diffPaid >= 0 ? '+' : ''}${formatCurrency(diffPaid)} –¥–µ–Ω
                            </td>
                            <td style="padding: 12px; text-align: right; color: ${diffPaid >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: 600;">
                                ${pctPaid !== 'N/A' ? (pctPaid >= 0 ? '+' : '') + pctPaid + '%' : 'N/A'}
                            </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: 600;">–û—Å—Ç–∞—Ç–æ–∫</td>
                            <td style="padding: 12px; text-align: right;">${formatCurrency(totals1.remaining)} –¥–µ–Ω</td>
                            <td style="padding: 12px; text-align: right;">${formatCurrency(totals2.remaining)} –¥–µ–Ω</td>
                            <td style="padding: 12px; text-align: right; color: ${diffRemaining <= 0 ? '#27ae60' : '#e74c3c'};">
                                ${diffRemaining >= 0 ? '+' : ''}${formatCurrency(diffRemaining)} –¥–µ–Ω
                            </td>
                            <td style="padding: 12px; text-align: right; color: ${diffRemaining <= 0 ? '#27ae60' : '#e74c3c'}; font-weight: 600;">
                                ${pctRemaining !== 'N/A' ? (pctRemaining >= 0 ? '+' : '') + pctRemaining + '%' : 'N/A'}
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            document.getElementById('advancedReportContent').innerHTML = html;
            document.getElementById('advancedReportResults').style.display = 'block';
        }

        function exportAdvancedReportCSV() {
            if (!currentAdvancedReportData) return;
            
            let csv = '–§–∏—Ä–º–∞,–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞,–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞,–í–∫—É–ø–Ω–∞ —Å—É–º–∞,–ü–ª–∞—Ç–µ–Ω–æ,–û—Å—Ç–∞—Ç–æ–∫,–î–∞—Ç—É–º —Ñ–∞–∫—Ç—É—Ä–∞,–í–∞–ª—É—Ç–∞,–°—Ç–∞—Ç—É—Å,–ó–∞–±–µ–ª–µ—à–∫–∞\n';
            
            const data = currentAdvancedReportData.type === 'single' ? 
                         currentAdvancedReportData.data : 
                         [...currentAdvancedReportData.period1.data, ...currentAdvancedReportData.period2.data];
            
            data.forEach(inv => {
                const paidAmount = calculatePaidAmount(inv);
                const remainingAmount = calculateRemainingAmount(inv);
                const status = getPaymentStatus(inv);
                let statusText = status === 'paid' ? '–ü–ª–∞—Ç–µ–Ω–∞' : (status === 'partial' ? '–î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∞' : '–ù–µ–ø–ª–∞—Ç–µ–Ω–∞');
                
                csv += `"${inv.companyName || ''}","${inv.invoiceNumber || ''}","${inv.bankAccount || ''}","${inv.amount || 0}","${paidAmount}","${remainingAmount}","${inv.entryDate ? formatDate(inv.entryDate) : ''}","${inv.dueDate ? formatDate(inv.dueDate) : ''}","${statusText}","${inv.notes || ''}"\n`;
            });

            downloadCSV(csv, 'napreden_izvestaj_hotel_de_koka.csv');
        }

        function exportAdvancedReportJSON() {
            if (!currentAdvancedReportData) return;
            
            const exportData = {
                exportDate: new Date().toISOString(),
                reportType: currentAdvancedReportData.type,
                data: currentAdvancedReportData
            };
            
            const jsonStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_hotel_de_koka_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printAdvancedReport() {
            const printContent = document.getElementById('advancedReportContent').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>–ù–∞–ø—Ä–µ–¥–µ–Ω –∏–∑–≤–µ—à—Ç–∞—ò - –•–æ—Ç–µ–ª –î–µ –ö–û–ö–ê</title>');
            printWindow.document.write('<style>body{font-family: Arial, sans-serif; padding: 20px;} table{width:100%; border-collapse: collapse;} th,td{border:1px solid #ddd; padding:8px; text-align:left;} th{background:#667eea; color:white;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>üè® –•–æ—Ç–µ–ª –î–µ –ö–û–ö–ê</h1>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        // ========== –ö–†–ê–à –ù–ê –ù–ê–ü–†–ï–î–ï–ù –ò–ó–í–ï–®–¢–ê–à –°–ò–°–¢–ï–ú ==========

        function exportToCSV() {
            let csv = '–§–∏—Ä–º–∞,–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞,–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞,–í–∫—É–ø–Ω–∞ —Å—É–º–∞,–ü–ª–∞—Ç–µ–Ω–æ,–û—Å—Ç–∞—Ç–æ–∫,–î–∞—Ç—É–º —Ñ–∞–∫—Ç—É—Ä–∞,–í–∞–ª—É—Ç–∞,–°—Ç–∞—Ç—É—Å,–ó–∞–±–µ–ª–µ—à–∫–∞\n';
            
            filteredInvoices.forEach(inv => {
                const paidAmount = calculatePaidAmount(inv);
                const remainingAmount = calculateRemainingAmount(inv);
                const status = getPaymentStatus(inv);
                let statusText = status === 'paid' ? '–ü–ª–∞—Ç–µ–Ω–∞' : (status === 'partial' ? '–î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∞' : '–ù–µ–ø–ª–∞—Ç–µ–Ω–∞');
                
                csv += `"${inv.companyName || ''}","${inv.invoiceNumber || ''}","${inv.bankAccount || ''}","${inv.amount || 0}","${paidAmount}","${remainingAmount}","${inv.entryDate ? formatDate(inv.entryDate) : ''}","${inv.dueDate ? formatDate(inv.dueDate) : ''}","${statusText}","${inv.notes || ''}"\n`;
            });

            downloadCSV(csv, 'fakturi_hotel_de_koka.csv');
        }



        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    
                    if (lines.length < 2) {
                        alert('CSV —Ñ–∞—ò–ª–æ—Ç –µ –ø—Ä–∞–∑–µ–Ω –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω!');
                        return;
                    }
                    
                    // Parse header to find column indices
                    const header = lines[0].replace(/\r/g, '').split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    // Expected headers (flexible - can be in any order)
                    const columnMap = {
                        companyName: -1,
                        invoiceNumber: -1,
                        bankAccount: -1,
                        amount: -1,
                        entryDate: -1,
                        dueDate: -1,
                        notes: -1
                    };
                    
                    // Map columns (support both English and Macedonian headers)
                    header.forEach((col, index) => {
                        const colLower = col.toLowerCase();
                        if (colLower.includes('—Ñ–∏—Ä–º–∞') || colLower.includes('company')) {
                            columnMap.companyName = index;
                        } else if (colLower.includes('–±—Ä–æ—ò') && colLower.includes('—Ñ–∞–∫—Ç') || colLower.includes('invoice') && colLower.includes('number')) {
                            columnMap.invoiceNumber = index;
                        } else if (colLower.includes('–∂–∏—Ä–æ') || colLower.includes('—Å–º–µ—Ç–∫–∞') || colLower.includes('account')) {
                            columnMap.bankAccount = index;
                        } else if (colLower.includes('—Å—É–º–∞') || colLower.includes('–≤—Ä–µ–¥–Ω–æ—Å—Ç') || colLower.includes('amount') || colLower.includes('–≤–∫—É–ø–Ω–∞')) {
                            columnMap.amount = index;
                        } else if (colLower.includes('–¥–∞—Ç—É–º') && colLower.includes('—Ñ–∞–∫—Ç') || colLower.includes('entry') || colLower.includes('date') && !colLower.includes('–≤–∞–ª—É—Ç–∞')) {
                            columnMap.entryDate = index;
                        } else if (colLower.includes('–≤–∞–ª—É—Ç–∞') || colLower.includes('due')) {
                            columnMap.dueDate = index;
                        } else if (colLower.includes('–∑–∞–±–µ–ª–µ—à–∫–∞') || colLower.includes('notes') || colLower.includes('–∑–∞–±–µ–ª–µ—à–∫–∏')) {
                            columnMap.notes = index;
                        }
                    });
                    
                    // Check if required columns are found
                    if (columnMap.companyName === -1 || columnMap.invoiceNumber === -1 || columnMap.amount === -1) {
                        alert('CSV —Ñ–∞—ò–ª–æ—Ç –Ω–µ –≥–∏ —Å–æ–¥—Ä–∂–∏ –∑–∞–¥–æ–ª–∂–∏—Ç–µ–ª–Ω–∏—Ç–µ –∫–æ–ª–æ–Ω–∏ (–§–∏—Ä–º–∞, –ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞, –°—É–º–∞)!');
                        return;
                    }
                    
                    // Parse data rows
                    const importedInvoices = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].replace(/\r/g, '').trim();
                        if (!line) continue;
                        
                        // Parse CSV line (handle quoted fields)
                        const values = [];
                        let currentValue = '';
                        let insideQuotes = false;
                        
                        for (let char of line) {
                            if (char === '"') {
                                insideQuotes = !insideQuotes;
                            } else if (char === ',' && !insideQuotes) {
                                values.push(currentValue.trim().replace(/^"|"$/g, ''));
                                currentValue = '';
                            } else {
                                currentValue += char;
                            }
                        }
                        values.push(currentValue.trim().replace(/^"|"$/g, ''));
                        
                        // Skip if not enough values
                        if (values.length < 3) continue;
                        
                        // Parse date from DD.MM.YYYY or DD/MM/YYYY to YYYY-MM-DD
                        function parseDate(dateStr) {
                            if (!dateStr) return '';
                            // If already in YYYY-MM-DD format
                            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
                            // If in DD.MM.YYYY or DD/MM/YYYY format
                            const match = dateStr.match(/(\d{1,2})[\.\/](\d{1,2})[\.\/](\d{4})/);
                            if (match) {
                                const day = match[1].padStart(2, '0');
                                const month = match[2].padStart(2, '0');
                                const year = match[3];
                                return `${year}-${month}-${day}`;
                            }
                            return '';
                        }
                        
                        const invoice = {
                            companyName: values[columnMap.companyName] || '',
                            invoiceNumber: values[columnMap.invoiceNumber] || '',
                            bankAccount: columnMap.bankAccount !== -1 ? values[columnMap.bankAccount] || '' : '',
                            amount: parseFloat(values[columnMap.amount]?.replace(/[^0-9.-]/g, '') || 0),
                            entryDate: columnMap.entryDate !== -1 ? parseDate(values[columnMap.entryDate]) : '',
                            dueDate: columnMap.dueDate !== -1 ? parseDate(values[columnMap.dueDate]) : '',
                            notes: columnMap.notes !== -1 ? values[columnMap.notes] || '' : '',
                            payments: []
                        };
                        
                        // Validate required fields
                        if (invoice.companyName && invoice.invoiceNumber && invoice.amount > 0) {
                            importedInvoices.push(invoice);
                        }
                    }
                    
                    if (importedInvoices.length === 0) {
                        alert('–ù–µ —Å–µ –ø—Ä–æ–Ω–∞—ò–¥–µ–Ω–∏ –≤–∞–ª–∏–¥–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∏ –≤–æ CSV —Ñ–∞—ò–ª–æ—Ç!');
                        return;
                    }
                    
                    // Ask user what to do
                    const action = confirm(
                        `–ü—Ä–æ–Ω–∞—ò–¥–µ–Ω–∏ —Å–µ ${importedInvoices.length} —Ñ–∞–∫—Ç—É—Ä–∏.\n\n` +
                        `–ö–ª–∏–∫–Ω–µ—Ç–µ OK –∑–∞ –¥–∞ –≥–∏ –î–û–î–ê–î–ï–¢–ï –∫–æ–Ω –ø–æ—Å—Ç–æ–µ—á–∫–∏—Ç–µ —Ñ–∞–∫—Ç—É—Ä–∏.\n` +
                        `–ö–ª–∏–∫–Ω–µ—Ç–µ Cancel –∑–∞ –¥–∞ –≥–∏ –ó–ê–ú–ï–ù–ò–¢–ï —Å–∏—Ç–µ –ø–æ—Å—Ç–æ–µ—á–∫–∏ —Ñ–∞–∫—Ç—É—Ä–∏.`
                    );
                    
                    if (action) {
                        // Add to existing
                        invoices = [...invoices, ...importedInvoices];
                        showSyncStatus('success', `‚úì –î–æ–¥–∞–¥–µ–Ω–∏ —Å–µ ${importedInvoices.length} –Ω–æ–≤–∏ —Ñ–∞–∫—Ç—É—Ä–∏ –æ–¥ CSV!`);
                    } else {
                        // Replace all
                        if (confirm('–î–∞–ª–∏ —Å—Ç–µ –°–ò–ì–£–†–ù–ò –¥–µ–∫–∞ —Å–∞–∫–∞—Ç–µ –¥–∞ –≥–∏ –∏–∑–±—Ä–∏—à–µ—Ç–µ –°–ò–¢–ï –ø–æ—Å—Ç–æ–µ—á–∫–∏ —Ñ–∞–∫—Ç—É—Ä–∏ –∏ –¥–∞ –≥–∏ –∑–∞–º–µ–Ω–∏—Ç–µ —Å–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏—Ç–µ –æ–¥ CSV?')) {
                            invoices = importedInvoices;
                            showSyncStatus('success', `‚úì –§–∞–∫—Ç—É—Ä–∏—Ç–µ —Å–µ –∑–∞–º–µ–Ω–µ—Ç–∏! –í—á–∏—Ç–∞–Ω–∏ ${importedInvoices.length} —Ñ–∞–∫—Ç—É—Ä–∏ –æ–¥ CSV.`);
                        } else {
                            showSyncStatus('error', '‚úó –ò–º–ø–æ—Ä—Ç–æ—Ç –µ –æ—Ç–∫–∞–∂–∞–Ω.');
                            return;
                        }
                    }
                    
                    // Save and update
                    saveInvoices();
                    applyFilters();
                    
                } catch (error) {
                    console.error('CSV Import error:', error);
                    alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–∏—Ç–∞—ö–µ –Ω–∞ CSV —Ñ–∞—ò–ª–æ—Ç! –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ —Ñ–∞—ò–ª–æ—Ç –µ –≤–∞–ª–∏–¥–µ–Ω.');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }



        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Collect all invoices from all sheets
                    let allImportedInvoices = [];
                    let processedSheets = 0;
                    
                    // Process each sheet (each month)
                    workbook.SheetNames.forEach(sheetName => {
                        try {
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            if (jsonData.length < 2) return; // Skip empty sheets
                            
                            // Parse header
                            const header = jsonData[0].map(h => (h || '').toString().trim());
                            
                            // Map columns
                            const columnMap = {
                                companyName: -1,
                                invoiceNumber: -1,
                                bankAccount: -1,
                                totalAmount: -1,
                                paidAmount: -1,
                                remainingAmount: -1,
                                entryDate: -1,
                                dueDate: -1,
                                notes: -1
                            };
                            
                            header.forEach((col, index) => {
                                const colLower = col.toLowerCase();
                                if (colLower.includes('–∏–º–µ') && colLower.includes('—Ñ–∏—Ä–º–∞') || colLower.includes('company')) {
                                    columnMap.companyName = index;
                                } else if (colLower.includes('–±—Ä–æ—ò') && (colLower.includes('—Ñ–∞–∫—Ç') || colLower.includes('faktura')) || colLower.includes('invoice')) {
                                    columnMap.invoiceNumber = index;
                                } else if (colLower.includes('–∂–∏—Ä–æ') || colLower.includes('—Å–º–µ—Ç–∫–∞') || colLower.includes('zh-smetka') || colLower.includes('account')) {
                                    columnMap.bankAccount = index;
                                } else if (colLower.includes('vkupno') || colLower.includes('–≤–∫—É–ø–Ω–æ') || colLower.includes('total')) {
                                    columnMap.totalAmount = index;
                                } else if (colLower.includes('plateno') || colLower.includes('–ø–ª–∞—Ç–µ–Ω–æ') || colLower.includes('paid')) {
                                    columnMap.paidAmount = index;
                                } else if (colLower.includes('–æ—Å—Ç–∞–Ω–∞—Ç') || colLower.includes('–¥–æ–ª–≥') || colLower.includes('remaining') || colLower.includes('dole')) {
                                    columnMap.remainingAmount = index;
                                } else if (colLower.includes('datum') && colLower.includes('faktur') || colLower.includes('–¥–∞—Ç—É–º') && colLower.includes('—Ñ–∞–∫—Ç') || colLower.includes('entry')) {
                                    columnMap.entryDate = index;
                                } else if (colLower.includes('dospeva') || colLower.includes('–≤–∞–ª—É—Ç–∞') || colLower.includes('due')) {
                                    columnMap.dueDate = index;
                                }
                            });
                            
                            // Check required columns
                            if (columnMap.companyName === -1 || columnMap.invoiceNumber === -1) {
                                console.log(`Skipping sheet "${sheetName}" - missing required columns`);
                                return;
                            }
                            
                            // If totalAmount column not found, try to use paidAmount or remainingAmount
                            if (columnMap.totalAmount === -1) {
                                if (columnMap.paidAmount !== -1 && columnMap.remainingAmount !== -1) {
                                    // We can calculate total from paid + remaining
                                    columnMap.totalAmount = -2; // Special marker
                                }
                            }
                            
                            // Parse Excel date
                            function parseExcelDate(value) {
                                if (!value) return '';
                                
                                if (typeof value === 'string') {
                                    const match = value.match(/(\d{1,2})[\.\/](\d{1,2})[\.\/](\d{4})/);
                                    if (match) {
                                        const day = match[1].padStart(2, '0');
                                        const month = match[2].padStart(2, '0');
                                        const year = match[3];
                                        return `${year}-${month}-${day}`;
                                    }
                                    if (/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
                                }
                                
                                if (typeof value === 'number') {
                                    const date = XLSX.SSF.parse_date_code(value);
                                    if (date) {
                                        const year = date.y;
                                        const month = String(date.m).padStart(2, '0');
                                        const day = String(date.d).padStart(2, '0');
                                        return `${year}-${month}-${day}`;
                                    }
                                }
                                
                                return '';
                            }
                            
                            // Parse data rows
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (!row || row.length === 0) continue;
                                
                                const companyName = (row[columnMap.companyName] || '').toString().trim();
                                const invoiceNumber = (row[columnMap.invoiceNumber] || '').toString().trim();
                                
                                // Skip empty rows
                                if (!companyName || !invoiceNumber) continue;
                                
                                // Get amounts
                                let totalAmount = 0;
                                let paidAmount = 0;
                                
                                if (columnMap.totalAmount === -2) {
                                    // Calculate from paid + remaining
                                    const paid = parseFloat(row[columnMap.paidAmount]) || 0;
                                    const remaining = parseFloat(row[columnMap.remainingAmount]) || 0;
                                    totalAmount = paid + remaining;
                                    paidAmount = paid;
                                } else if (columnMap.totalAmount !== -1) {
                                    totalAmount = parseFloat(row[columnMap.totalAmount]) || 0;
                                    paidAmount = columnMap.paidAmount !== -1 ? (parseFloat(row[columnMap.paidAmount]) || 0) : 0;
                                }
                                
                                if (totalAmount <= 0) continue;
                                
                                const entryDate = columnMap.entryDate !== -1 ? parseExcelDate(row[columnMap.entryDate]) : '';
                                const dueDate = columnMap.dueDate !== -1 ? parseExcelDate(row[columnMap.dueDate]) : '';
                                
                                const invoice = {
                                    companyName: companyName,
                                    invoiceNumber: invoiceNumber,
                                    bankAccount: columnMap.bankAccount !== -1 ? (row[columnMap.bankAccount] || '').toString().trim() : '',
                                    amount: totalAmount,
                                    entryDate: entryDate,
                                    dueDate: dueDate,
                                    notes: `–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ –æ–¥ ${sheetName}`,
                                    payments: []
                                };
                                
                                // Add payment if there is paid amount
                                if (paidAmount > 0) {
                                    invoice.payments.push({
                                        amount: paidAmount,
                                        date: entryDate || new Date().toISOString().split('T')[0],
                                        note: `–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ –ø–ª–∞—ú–∞—ö–µ –æ–¥ ${sheetName}`
                                    });
                                }
                                
                                allImportedInvoices.push(invoice);
                            }
                            
                            processedSheets++;
                            
                        } catch (sheetError) {
                            console.error(`Error processing sheet "${sheetName}":`, sheetError);
                        }
                    });
                    
                    if (allImportedInvoices.length === 0) {
                        alert(`–ù–µ —Å–µ –ø—Ä–æ–Ω–∞—ò–¥–µ–Ω–∏ –≤–∞–ª–∏–¥–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∏ –≤–æ Excel —Ñ–∞—ò–ª–æ—Ç!\n–ü—Ä–æ—Ü–µ—Å–∏—Ä–∞–Ω–∏ –ª–∏—Å—Ç–æ–≤–∏: ${processedSheets}`);
                        return;
                    }
                    
                    // Ask user what to do
                    const action = confirm(
                        `–ü—Ä–æ–Ω–∞—ò–¥–µ–Ω–∏ —Å–µ ${allImportedInvoices.length} —Ñ–∞–∫—Ç—É—Ä–∏ –æ–¥ ${processedSheets} –ª–∏—Å—Ç–æ–≤–∏ (–º–µ—Å–µ—Ü–∏).\n\n` +
                        `–ö–ª–∏–∫–Ω–µ—Ç–µ OK –∑–∞ –¥–∞ –≥–∏ –î–û–î–ê–î–ï–¢–ï –∫–æ–Ω –ø–æ—Å—Ç–æ–µ—á–∫–∏—Ç–µ —Ñ–∞–∫—Ç—É—Ä–∏.\n` +
                        `–ö–ª–∏–∫–Ω–µ—Ç–µ Cancel –∑–∞ –¥–∞ –≥–∏ –ó–ê–ú–ï–ù–ò–¢–ï —Å–∏—Ç–µ –ø–æ—Å—Ç–æ–µ—á–∫–∏ —Ñ–∞–∫—Ç—É—Ä–∏.`
                    );
                    
                    if (action) {
                        // Add to existing
                        invoices = [...invoices, ...allImportedInvoices];
                        showSyncStatus('success', `‚úì –î–æ–¥–∞–¥–µ–Ω–∏ —Å–µ ${allImportedInvoices.length} —Ñ–∞–∫—Ç—É—Ä–∏ –æ–¥ ${processedSheets} –º–µ—Å–µ—Ü–∏!`);
                    } else {
                        // Replace all
                        if (confirm('–î–∞–ª–∏ —Å—Ç–µ –°–ò–ì–£–†–ù–ò –¥–µ–∫–∞ —Å–∞–∫–∞—Ç–µ –¥–∞ –≥–∏ –∏–∑–±—Ä–∏—à–µ—Ç–µ –°–ò–¢–ï –ø–æ—Å—Ç–æ–µ—á–∫–∏ —Ñ–∞–∫—Ç—É—Ä–∏ –∏ –¥–∞ –≥–∏ –∑–∞–º–µ–Ω–∏—Ç–µ —Å–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏—Ç–µ –æ–¥ Excel?')) {
                            invoices = allImportedInvoices;
                            showSyncStatus('success', `‚úì –§–∞–∫—Ç—É—Ä–∏—Ç–µ —Å–µ –∑–∞–º–µ–Ω–µ—Ç–∏! –í—á–∏—Ç–∞–Ω–∏ ${allImportedInvoices.length} —Ñ–∞–∫—Ç—É—Ä–∏ –æ–¥ ${processedSheets} –º–µ—Å–µ—Ü–∏.`);
                        } else {
                            showSyncStatus('error', '‚úó –ò–º–ø–æ—Ä—Ç–æ—Ç –µ –æ—Ç–∫–∞–∂–∞–Ω.');
                            return;
                        }
                    }
                    
                    // Save and update
                    saveInvoices();
                    applyFilters();
                    
                } catch (error) {
                    console.error('Excel Import error:', error);
                    alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–∏—Ç–∞—ö–µ –Ω–∞ Excel —Ñ–∞—ò–ª–æ—Ç! –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ —Ñ–∞—ò–ª–æ—Ç –µ –≤–∞–ª–∏–¥–µ–Ω.\n–ì—Ä–µ—à–∫–∞: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }


        function exportReportToCSV() {
            if (!currentReportData) return;
            
            let csv = '–§–∏—Ä–º–∞,–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞,–ñ–∏—Ä–æ —Å–º–µ—Ç–∫–∞,–í–∫—É–ø–Ω–∞ —Å—É–º–∞,–ü–ª–∞—Ç–µ–Ω–æ,–û—Å—Ç–∞—Ç–æ–∫,–î–∞—Ç—É–º —Ñ–∞–∫—Ç—É—Ä–∞,–í–∞–ª—É—Ç–∞,–°—Ç–∞—Ç—É—Å,–ó–∞–±–µ–ª–µ—à–∫–∞\n';
            
            currentReportData.forEach(inv => {
                const paidAmount = calculatePaidAmount(inv);
                const remainingAmount = calculateRemainingAmount(inv);
                const status = getPaymentStatus(inv);
                let statusText = status === 'paid' ? '–ü–ª–∞—Ç–µ–Ω–∞' : (status === 'partial' ? '–î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∞' : '–ù–µ–ø–ª–∞—Ç–µ–Ω–∞');
                
                csv += `"${inv.companyName || ''}","${inv.invoiceNumber || ''}","${inv.bankAccount || ''}","${inv.amount || 0}","${paidAmount}","${remainingAmount}","${inv.entryDate ? formatDate(inv.entryDate) : ''}","${inv.dueDate ? formatDate(inv.dueDate) : ''}","${statusText}","${inv.notes || ''}"\n`;
            });

            downloadCSV(csv, 'izvestaj_hotel_de_koka.csv');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printReport() {
            window.print();
        }

        function printModal() {
            const printContent = document.getElementById('reportContent').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>–ò–∑–≤–µ—à—Ç–∞—ò - –•–æ—Ç–µ–ª –î–µ –ö–û–ö–ê</title>');
            printWindow.document.write('<style>body{font-family: Arial, sans-serif; padding: 20px;} table{width:100%; border-collapse: collapse;} th,td{border:1px solid #ddd; padding:8px; text-align:left;} th{background:#667eea; color:white;} .detail-row{display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;} .detail-label{font-weight:600;} .detail-value{color:#667eea; font-weight:600;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>üè® –•–æ—Ç–µ–ª –î–µ –ö–û–ö–ê</h1>');
            printWindow.document.write('<h2>' + document.getElementById('reportTitle').textContent + '</h2>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            currentReportData = null;
        }

        function openEditModal(index) {
            const invoice = invoices[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('editCompanyName').value = invoice.companyName || '';
            document.getElementById('editInvoiceNumber').value = invoice.invoiceNumber || '';
            document.getElementById('editBankAccount').value = invoice.bankAccount || '';
            document.getElementById('editAmount').value = invoice.amount || '';
            document.getElementById('editEntryDate').value = invoice.entryDate || '';
            document.getElementById('editDueDate').value = invoice.dueDate || '';
            document.getElementById('editNotes').value = invoice.notes || '';
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function deleteInvoice(index) {
            if (confirm('–î–∞–ª–∏ —Å—Ç–µ —Å–∏–≥—É—Ä–Ω–∏ –¥–µ–∫–∞ —Å–∞–∫–∞—Ç–µ –¥–∞ —ò–∞ –∏–∑–±—Ä–∏—à–µ—Ç–µ –æ–≤–∞–∞ —Ñ–∞–∫—Ç—É—Ä–∞?')) {
                invoices.splice(index, 1);
                saveInvoices();
                applyFilters();
            }
        }

        document.getElementById('invoiceForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const invoice = {
                companyName: document.getElementById('companyName').value,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                bankAccount: document.getElementById('bankAccount').value,
                amount: parseFloat(document.getElementById('amount').value),
                entryDate: document.getElementById('entryDate').value,
                dueDate: document.getElementById('dueDate').value,
                notes: document.getElementById('notes').value,
                payments: []
            };

            invoices.push(invoice);
            saveInvoices();
            applyFilters();

            this.reset();
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('dueDate').value = new Date().toISOString().split('T')[0];
        });

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const index = parseInt(document.getElementById('editIndex').value);
            const invoice = invoices[index];
            
            invoice.companyName = document.getElementById('editCompanyName').value;
            invoice.invoiceNumber = document.getElementById('editInvoiceNumber').value;
            invoice.bankAccount = document.getElementById('editBankAccount').value;
            invoice.amount = parseFloat(document.getElementById('editAmount').value);
            invoice.entryDate = document.getElementById('editEntryDate').value;
            invoice.dueDate = document.getElementById('editDueDate').value;
            invoice.notes = document.getElementById('editNotes').value;

            saveInvoices();
            closeEditModal();
            applyFilters();
        });

        document.getElementById('globalSearch').addEventListener('input', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterCompany').addEventListener('input', applyFilters);
        document.getElementById('filterAccount').addEventListener('input', applyFilters);
        document.getElementById('filterInvoiceNumber').addEventListener('input', applyFilters);
        document.getElementById('filterDateFrom').addEventListener('change', applyFilters);
        document.getElementById('filterDateTo').addEventListener('change', applyFilters);

        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const reportModal = document.getElementById('reportModal');
            const paymentModal = document.getElementById('paymentModal');
            const advancedReportModal = document.getElementById('advancedReportModal');
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == reportModal) {
                closeReportModal();
            }
            if (event.target == paymentModal) {
                closePaymentModal();
            }
            if (event.target == advancedReportModal) {
                closeAdvancedReport();
            }
        }

        // Initialize dates
        document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('dueDate').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>
