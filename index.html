<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–•–æ—Ç–µ–ª –î–µ –ö–û–ö–ê - –§–∏–Ω–∞–Ω—Å–∏–∏</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        /* Sync Indicator Styles */
        #sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            transition: all 0.3s ease;
            display: none;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .btn-small {
            font-size: 12px;
            padding: 6px 12px;
            white-space: nowrap;
        }

        .btn-table {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .filter-section {
            background: #e8f4f8;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .search-box {
            grid-column: 1 / -1;
        }

        .table-section {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-paid {
            color: #27ae60;
            font-weight: 600;
        }

        .status-unpaid {
            color: #e74c3c;
            font-weight: 600;
        }

        .status-partial {
            color: #f39c12;
            font-weight: 600;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .summary-card.active {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.5);
        }

        .summary-card h3 {
            font-size: 1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card p {
            font-size: 2em;
            font-weight: 700;
        }

        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .history-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 5px;
        }

        .history-dropdown.show {
            display: block;
        }

        .history-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: #f0f4ff;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item-company {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .history-item-details {
            font-size: 0.9em;
            color: #666;
        }

        .history-item-account {
            color: #667eea;
            font-family: monospace;
        }

        .history-item-amount {
            color: #27ae60;
            font-weight: 600;
        }

        .history-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .no-history {
            padding: 15px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        .payment-info {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .payment-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .payment-info-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1em;
            color: #667eea;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #667eea;
        }

        .payments-list {
            margin-top: 20px;
        }

        .payment-item {
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-item.editing {
            border: 2px solid #667eea;
            background: #f0f4ff;
        }

        .payment-item-info {
            flex: 1;
        }

        .payment-item-date {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .payment-item-amount {
            color: #27ae60;
            font-weight: 600;
            font-size: 1.1em;
        }

        .payment-edit-form {
            display: none;
            flex: 1;
            gap: 10px;
        }

        .payment-edit-form.active {
            display: flex;
            flex-direction: column;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .sync-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 4px;
            }

            #sync-indicator {
                bottom: 10px;
                right: 10px;
                font-size: 12px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Sync Indicator -->
    <div id="sync-indicator"></div>

    <div class="container">
        <h1>üè® –•–æ—Ç–µ–ª –î–µ –ö–û–ö–ê</h1>
        <p class="subtitle">–°–∏—Å—Ç–µ–º –∑–∞ —É–ø—Ä–∞–≤—É–≤–∞—ö–µ —Å–æ —Ñ–∞–∫—Ç—É—Ä–∏ –∏ –ø–ª–∞—ú–∞—ö–∞</p>

        <!-- Sync Buttons -->
        <div class="sync-buttons">
            <button class="btn btn-success btn-small" onclick="loadFromGoogleSheets()">‚¨áÔ∏è –í—á–∏—Ç–∞—ò –æ–¥ Google Sheets</button>
            <button class="btn btn-info btn-small" onclick="manualSyncToSheets()">‚òÅÔ∏è Sync —Å–æ Google Sheets</button>
        </div>

        <!-- Summary Cards -->
        <div class="summary">
            <div class="summary-card" id="card-all" onclick="filterByStatus('all')">
                <h3>–í–∫—É–ø–Ω–æ –§–∞–∫—Ç—É—Ä–∏</h3>
                <p id="totalInvoices">0</p>
            </div>
            <div class="summary-card" id="card-paid" onclick="filterByStatus('paid')">
                <h3>‚úì –ü–ª–∞—Ç–µ–Ω–∏</h3>
                <p id="paidInvoices">0</p>
            </div>
            <div class="summary-card" id="card-partial" onclick="filterByStatus('partial')">
                <h3>‚ö° –î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∏</h3>
                <p id="partialInvoices">0</p>
            </div>
            <div class="summary-card" id="card-unpaid" onclick="filterByStatus('unpaid')">
                <h3>‚è≥ –ù–µ–ø–ª–∞—Ç–µ–Ω–∏</h3>
                <p id="unpaidInvoices">0</p>
            </div>
            <div class="summary-card">
                <h3>üí∞ –í–∫—É–ø–Ω–∞ –°—É–º–∞</h3>
                <p id="totalAmount">0 –¥–µ–Ω</p>
            </div>
            <div class="summary-card">
                <h3>üíµ –ü–ª–∞—Ç–µ–Ω–æ</h3>
                <p id="paidAmount">0 –¥–µ–Ω</p>
            </div>
            <div class="summary-card">
                <h3>‚è∞ –ù–µ–ø–ª–∞—Ç–µ–Ω–æ</h3>
                <p id="unpaidAmount">0 –¥–µ–Ω</p>
            </div>
        </div>

        <!-- Add Invoice Button -->
        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="openAddInvoiceModal()">‚ûï –î–æ–¥–∞–¥–∏ –§–∞–∫—Ç—É—Ä–∞</button>
            <button class="btn btn-success" onclick="exportToExcel()">üì• –ò–∑–≤–µ–∑–∏ –≤–æ Excel</button>
            <button class="btn btn-info" onclick="showReport()">üìä –ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –ò–∑–≤–µ—à—Ç–∞—ò</button>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <h3 style="margin-bottom: 15px; color: #333;">üîç –§–∏–ª—Ç—Ä–∏ –∑–∞ –ø—Ä–µ–±–∞—Ä—É–≤–∞—ö–µ</h3>
            <div class="filter-grid">
                <div class="form-group">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select id="filterStatus">
                        <option value="all">–°–∏—Ç–µ</option>
                        <option value="paid">–ü–ª–∞—Ç–µ–Ω–∏</option>
                        <option value="partial">–î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∏</option>
                        <option value="unpaid">–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ö–æ–º–ø–∞–Ω–∏—ò–∞</label>
                    <input type="text" id="filterCompany" placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò –ø–æ –∏–º–µ...">
                </div>
                <div class="form-group">
                    <label>–ë—Ä–æ—ò –Ω–∞ —Å–º–µ—Ç–∫–∞</label>
                    <input type="text" id="filterAccount" placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò –ø–æ —Å–º–µ—Ç–∫–∞...">
                </div>
                <div class="form-group">
                    <label>–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞</label>
                    <input type="text" id="filterInvoiceNumber" placeholder="–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞...">
                </div>
                <div class="form-group">
                    <label>–û–¥ –¥–∞—Ç—É–º</label>
                    <input type="date" id="filterDateFrom">
                </div>
                <div class="form-group">
                    <label>–î–æ –¥–∞—Ç—É–º</label>
                    <input type="date" id="filterDateTo">
                </div>
            </div>
            <div class="search-box">
                <label>–ì–ª–æ–±–∞–ª–Ω–æ –ø—Ä–µ–±–∞—Ä—É–≤–∞—ö–µ</label>
                <input type="text" id="globalSearch" placeholder="–ü—Ä–µ–±–∞—Ä—É–≤–∞—ò –Ω–∏–∑ —Å–∏—Ç–µ –ø–æ–ª–∏—ö–∞...">
            </div>
        </div>

        <!-- Table -->
        <div class="table-section">
            <table id="invoiceTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>–ö–æ–º–ø–∞–Ω–∏—ò–∞</th>
                        <th>–ë—Ä–æ—ò —Ñ–∞–∫—Ç—É—Ä–∞</th>
                        <th>–°–º–µ—Ç–∫–∞</th>
                        <th>–ò–∑–Ω–æ—Å</th>
                        <th>–ü–ª–∞—Ç–µ–Ω–æ</th>
                        <th>–ü—Ä–µ–æ—Å—Ç–∞–Ω–∞—Ç–æ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–∞—Ç—É–º –Ω–∞ –≤–Ω–µ—Å</th>
                        <th>–†–æ–∫</th>
                        <th>–ê–∫—Ü–∏–∏</th>
                    </tr>
                </thead>
                <tbody id="invoiceTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Invoice Modal -->
    <div id="addInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï –î–æ–¥–∞–¥–∏ –§–∞–∫—Ç—É—Ä–∞</h2>
                <span class="close" onclick="closeAddInvoiceModal()">&times;</span>
            </div>
            <form id="invoiceForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>–ò–º–µ –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—ò–∞ *</label>
                        <input type="text" id="companyName" required autocomplete="off">
                        <div id="companyHistory" class="history-dropdown"></div>
                    </div>
                    <div class="form-group">
                        <label>–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞ *</label>
                        <input type="text" id="invoiceNumber" required>
                    </div>
                    <div class="form-group">
                        <label>–ë—Ä–æ—ò –Ω–∞ —Å–º–µ—Ç–∫–∞</label>
                        <input type="text" id="bankAccount">
                    </div>
                    <div class="form-group">
                        <label>–ò–∑–Ω–æ—Å (–¥–µ–Ω) *</label>
                        <input type="number" id="amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>–î–∞—Ç—É–º –Ω–∞ –≤–Ω–µ—Å *</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label>–†–æ–∫ –∑–∞ –ø–ª–∞—ú–∞—ö–µ *</label>
                        <input type="date" id="dueDate" required>
                    </div>
                    <div class="form-group full-width">
                        <label>–ó–∞–±–µ–ª–µ—à–∫–∏</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label style="margin-bottom: 10px;">–°—Ç–∞—Ç—É—Å –Ω–∞ –ø–ª–∞—ú–∞—ö–µ *</label>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="initialStatus" value="unpaid" checked>
                                <span>‚è≥ –ù–µ–ø–ª–∞—Ç–µ–Ω–∞</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="initialStatus" value="paid">
                                <span>‚úì –ü–ª–∞—Ç–µ–Ω–∞ (—Ü–µ–ª–∞ —Å—É–º–∞)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="initialStatus" value="partial">
                                <span>‚ö° –î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∞</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group full-width" id="partialPaidGroup" style="display: none;">
                        <label>–î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∞ —Å—É–º–∞ (–¥–µ–Ω)</label>
                        <input type="number" id="partialPaidAmount" step="0.01" min="0">
                    </div>
                    <input type="checkbox" id="isPaidCash" style="display: none;">
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">‚úì –ó–∞—á—É–≤–∞—ò</button>
                    <button type="button" class="btn btn-danger" onclick="closeAddInvoiceModal()">‚úó –û—Ç–∫–∞–∂–∏</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Invoice Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è –ò–∑–º–µ–Ω–∏ –§–∞–∫—Ç—É—Ä–∞</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editIndex">
                <div class="form-grid">
                    <div class="form-group">
                        <label>–ò–º–µ –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—ò–∞ *</label>
                        <input type="text" id="editCompanyName" required>
                    </div>
                    <div class="form-group">
                        <label>–ë—Ä–æ—ò –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞ *</label>
                        <input type="text" id="editInvoiceNumber" required>
                    </div>
                    <div class="form-group">
                        <label>–ë—Ä–æ—ò –Ω–∞ —Å–º–µ—Ç–∫–∞</label>
                        <input type="text" id="editBankAccount">
                    </div>
                    <div class="form-group">
                        <label>–ò–∑–Ω–æ—Å (–¥–µ–Ω) *</label>
                        <input type="number" id="editAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>–î–∞—Ç—É–º –Ω–∞ –≤–Ω–µ—Å *</label>
                        <input type="date" id="editEntryDate" required>
                    </div>
                    <div class="form-group">
                        <label>–†–æ–∫ –∑–∞ –ø–ª–∞—ú–∞—ö–µ *</label>
                        <input type="date" id="editDueDate" required>
                    </div>
                    <div class="form-group full-width">
                        <label>–ó–∞–±–µ–ª–µ—à–∫–∏</label>
                        <textarea id="editNotes" rows="3"></textarea>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">‚úì –ó–∞—á—É–≤–∞—ò</button>
                    <button type="button" class="btn btn-danger" onclick="closeEditModal()">‚úó –û—Ç–∫–∞–∂–∏</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∞ –£–ø—Ä–∞–≤—É–≤–∞—ö–µ —Å–æ –ø–ª–∞—ú–∞—ö–∞</h2>
                <span class="close" onclick="closePaymentModal()">&times;</span>
            </div>
            <div id="paymentModalContent"></div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä –ò–∑–≤–µ—à—Ç–∞—ò</h2>
                <span class="close" onclick="closeReportModal()">&times;</span>
            </div>
            <div id="reportContent"></div>
        </div>
    </div>

<script>
// ===== GOOGLE SHEETS CONFIGURATION =====
const GOOGLE_SHEETS_CONFIG = {
    webAppUrl: 'https://script.google.com/macros/s/AKfycbxADkb4ZD9IrVD7hAB2ZE32MFQhKaXF5UZwC_slbDZT6WwNH3lDW9B_qiVzRrX3lXQD0g/exec',
    enabled: true // Set to false to use localStorage only
};

// ===== LOCAL STORAGE (BACKUP) =====
const STORAGE_KEY = 'hotelkoka_invoices';
const STORAGE_VERSION = '1.0';

// ===== SYNC INDICATOR FUNCTION =====
function showSyncIndicator(status) {
    let indicator = document.getElementById('sync-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'sync-indicator';
        document.body.appendChild(indicator);
    }
    
    indicator.style.display = 'block';
    
    if (status === 'syncing') {
        indicator.style.background = '#3498db';
        indicator.style.color = 'white';
        indicator.textContent = '‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞...';
    } else if (status === 'success') {
        indicator.style.background = '#27ae60';
        indicator.style.color = 'white';
        indicator.textContent = '‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞–Ω–æ!';
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 3000);
    } else if (status === 'error') {
        indicator.style.background = '#e74c3c';
        indicator.style.color = 'white';
        indicator.textContent = '‚úó –ì—Ä–µ—à–∫–∞!';
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 3000);
    }
}

// ===== GOOGLE SHEETS FUNCTIONS =====
async function loadFromGoogleSheets() {
    if (!GOOGLE_SHEETS_CONFIG.enabled) {
        console.log('Google Sheets integration disabled');
        return false;
    }

    try {
        showSyncIndicator('syncing');
        
        const response = await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl);
        
        if (!response.ok) {
            throw new Error(`Apps Script error: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error('Failed to load data from Apps Script');
        }
        
        if (!result.data || result.data.length === 0) {
            console.log('No data in Google Sheets');
            invoices = [];
            showSyncIndicator('success');
            saveToLocalStorage();
            applyFilters();
            return true;
        }
        
        // Convert sheet rows to invoices
        invoices = result.data.map(row => ({
            id: String(row[0] || generateId()),
            companyName: row[1] || '',
            invoiceNumber: row[2] || '',
            bankAccount: row[3] || '',
            amount: parseFloat(row[4]) || 0,
            entryDate: row[5] || '',
            dueDate: row[6] || '',
            notes: row[7] || '',
            payments: row[8] ? JSON.parse(row[8]) : [],
            timestamp: row[9] || new Date().toISOString()
        }));
        
        console.log('‚úÖ Loaded from Google Sheets:', invoices.length, 'invoices');
        showSyncIndicator('success');
        
        // Save to localStorage as backup
        saveToLocalStorage();
        applyFilters();
        
        return true;
    } catch (error) {
        console.error('‚ùå Error loading from Google Sheets:', error);
        showSyncIndicator('error');
        alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—á–∏—Ç—É–≤–∞—ö–µ –æ–¥ Google Sheets. –å–µ —Å–µ –∫–æ—Ä–∏—Å—Ç–∞—Ç –ª–æ–∫–∞–ª–Ω–∏ –ø–æ–¥–∞—Ç–æ—Ü–∏.');
        
        // Fallback to localStorage
        loadFromLocalStorage();
        return false;
    }
}

async function saveToGoogleSheets() {
    if (!GOOGLE_SHEETS_CONFIG.enabled) {
        console.log('Google Sheets integration disabled');
        return false;
    }

    try {
        showSyncIndicator('syncing');
        
        // Prepare data to send
        const dataToSend = {
            invoices: invoices.map(inv => ({
                id: inv.id || generateId(),
                companyName: inv.companyName || '',
                invoiceNumber: inv.invoiceNumber || '',
                bankAccount: inv.bankAccount || '',
                amount: inv.amount || 0,
                entryDate: inv.entryDate || '',
                dueDate: inv.dueDate || '',
                notes: inv.notes || '',
                payments: inv.payments || [],
                timestamp: inv.timestamp || new Date().toISOString()
            }))
        };
        
        // Send with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain',
            },
            body: JSON.stringify(dataToSend),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (response.ok) {
            console.log('‚úÖ Synced to Google Sheets:', invoices.length, 'invoices');
            showSyncIndicator('success');
            
            // Save to localStorage as backup
            saveToLocalStorage();
            return true;
        } else {
            throw new Error('Server returned: ' + response.status);
        }
        
    } catch (error) {
        console.error('‚ùå Error syncing to Google Sheets:', error);
        showSyncIndicator('error');
        
        // Fallback to localStorage
        saveToLocalStorage();
        return false;
    }
}

// Manual sync button
async function manualSyncToSheets() {
    const result = await saveToGoogleSheets();
    if (result) {
        alert('‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞–Ω–æ —Å–æ Google Sheets!');
    } else {
        alert('‚ö†Ô∏è –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—ò–∞. –ü–æ–¥–∞—Ç–æ—Ü–∏—Ç–µ —Å–µ –∑–∞—á—É–≤–∞–Ω–∏ –ª–æ–∫–∞–ª–Ω–æ.');
    }
}

// ===== LOCAL STORAGE FUNCTIONS =====
function saveToLocalStorage() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
        localStorage.setItem(STORAGE_KEY + '_version', STORAGE_VERSION);
        return true;
    } catch (error) {
        console.error('Error saving to localStorage:', error);
        return false;
    }
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        try {
            invoices = JSON.parse(saved);
            applyFilters();
            return true;
        } catch (e) {
            console.error('Error loading from localStorage:', e);
            invoices = [];
            return false;
        }
    }
    return false;
}

// ===== MAIN APPLICATION CODE =====
let invoices = [];
let currentFilter = 'all';

function generateId() {
    return 'inv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function getInvoiceStatus(invoice) {
    const totalPaid = invoice.payments ? invoice.payments.reduce((sum, p) => sum + p.amount, 0) : 0;
    const remaining = invoice.amount - totalPaid;
    
    if (remaining === 0) return 'paid';
    if (totalPaid > 0) return 'partial';
    return 'unpaid';
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('mk-MK', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount) + ' –¥–µ–Ω';
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('mk-MK');
}

function updateSummary() {
    const stats = {
        total: 0,
        paid: 0,
        partial: 0,
        unpaid: 0,
        totalAmount: 0,
        paidAmount: 0,
        unpaidAmount: 0
    };

    invoices.forEach(invoice => {
        stats.total++;
        stats.totalAmount += invoice.amount;
        
        const totalPaid = invoice.payments ? invoice.payments.reduce((sum, p) => sum + p.amount, 0) : 0;
        stats.paidAmount += totalPaid;
        stats.unpaidAmount += (invoice.amount - totalPaid);
        
        const status = getInvoiceStatus(invoice);
        if (status === 'paid') stats.paid++;
        else if (status === 'partial') stats.partial++;
        else stats.unpaid++;
    });

    document.getElementById('totalInvoices').textContent = stats.total;
    document.getElementById('paidInvoices').textContent = stats.paid;
    document.getElementById('partialInvoices').textContent = stats.partial;
    document.getElementById('unpaidInvoices').textContent = stats.unpaid;
    document.getElementById('totalAmount').textContent = formatCurrency(stats.totalAmount);
    document.getElementById('paidAmount').textContent = formatCurrency(stats.paidAmount);
    document.getElementById('unpaidAmount').textContent = formatCurrency(stats.unpaidAmount);
}

function renderTable() {
    const tbody = document.getElementById('invoiceTableBody');
    const globalSearch = document.getElementById('globalSearch').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const companyFilter = document.getElementById('filterCompany').value.toLowerCase();
    const accountFilter = document.getElementById('filterAccount').value.toLowerCase();
    const invoiceNumFilter = document.getElementById('filterInvoiceNumber').value.toLowerCase();
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;

    let filtered = invoices.filter(invoice => {
        const status = getInvoiceStatus(invoice);

        // Status filter
        if (statusFilter !== 'all' && status !== statusFilter) return false;

        // Company filter
        if (companyFilter && !invoice.companyName.toLowerCase().includes(companyFilter)) return false;

        // Account filter
        if (accountFilter && (!invoice.bankAccount || !invoice.bankAccount.toLowerCase().includes(accountFilter))) return false;

        // Invoice number filter
        if (invoiceNumFilter && !invoice.invoiceNumber.toLowerCase().includes(invoiceNumFilter)) return false;

        // Date filters
        if (dateFrom && invoice.entryDate < dateFrom) return false;
        if (dateTo && invoice.entryDate > dateTo) return false;

        // Global search
        if (globalSearch) {
            const searchStr = `${invoice.companyName} ${invoice.invoiceNumber} ${invoice.bankAccount || ''} ${invoice.amount} ${invoice.notes || ''}`.toLowerCase();
            if (!searchStr.includes(globalSearch)) return false;
        }

        return true;
    });

    tbody.innerHTML = '';
    
    filtered.forEach((invoice, index) => {
        const actualIndex = invoices.indexOf(invoice);
        const totalPaid = invoice.payments ? invoice.payments.reduce((sum, p) => sum + p.amount, 0) : 0;
        const remaining = invoice.amount - totalPaid;
        const status = getInvoiceStatus(invoice);
        
        let statusText = '';
        let statusClass = '';
        
        if (status === 'paid') {
            statusText = '‚úì –ü–ª–∞—Ç–µ–Ω–∞';
            statusClass = 'status-paid';
        } else if (status === 'partial') {
            statusText = '‚ö° –î–µ–ª—É–º–Ω–æ';
            statusClass = 'status-partial';
        } else {
            statusText = '‚è≥ –ù–µ–ø–ª–∞—Ç–µ–Ω–∞';
            statusClass = 'status-unpaid';
        }

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${invoice.companyName}</td>
            <td>${invoice.invoiceNumber}</td>
            <td>${invoice.bankAccount || '-'}</td>
            <td>${formatCurrency(invoice.amount)}</td>
            <td>${formatCurrency(totalPaid)}</td>
            <td>${formatCurrency(remaining)}</td>
            <td class="${statusClass}">${statusText}</td>
            <td>${formatDate(invoice.entryDate)}</td>
            <td>${formatDate(invoice.dueDate)}</td>
            <td class="actions">
                <button class="btn btn-info btn-table" onclick="openPaymentModal(${actualIndex})">üí∞</button>
                <button class="btn btn-warning btn-table" onclick="editInvoice(${actualIndex})">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-table" onclick="deleteInvoice(${actualIndex})">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    updateSummary();
}

function applyFilters() {
    renderTable();
}

function filterByStatus(status) {
    currentFilter = status;
    document.getElementById('filterStatus').value = status;
    
    // Update active card
    document.querySelectorAll('.summary-card').forEach(card => {
        card.classList.remove('active');
    });
    document.getElementById('card-' + status).classList.add('active');
    
    applyFilters();
}

async function deleteInvoice(index) {
    if (!confirm('–î–∞–ª–∏ —Å—Ç–µ —Å–∏–≥—É—Ä–Ω–∏ –¥–µ–∫–∞ —Å–∞–∫–∞—Ç–µ –¥–∞ —ò–∞ –∏–∑–±—Ä–∏—à–µ—Ç–µ –æ–≤–∞–∞ —Ñ–∞–∫—Ç—É—Ä–∞?')) return;
    
    invoices.splice(index, 1);
    await saveToGoogleSheets();
    applyFilters();
}

function editInvoice(index) {
    const invoice = invoices[index];
    
    document.getElementById('editIndex').value = index;
    document.getElementById('editCompanyName').value = invoice.companyName;
    document.getElementById('editInvoiceNumber').value = invoice.invoiceNumber;
    document.getElementById('editBankAccount').value = invoice.bankAccount || '';
    document.getElementById('editAmount').value = invoice.amount;
    document.getElementById('editEntryDate').value = invoice.entryDate;
    document.getElementById('editDueDate').value = invoice.dueDate;
    document.getElementById('editNotes').value = invoice.notes || '';
    
    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

function openPaymentModal(index) {
    const invoice = invoices[index];
    const totalPaid = invoice.payments ? invoice.payments.reduce((sum, p) => sum + p.amount, 0) : 0;
    const remaining = invoice.amount - totalPaid;
    const progressPercent = (totalPaid / invoice.amount * 100).toFixed(1);

    let paymentsHTML = '';
    if (invoice.payments && invoice.payments.length > 0) {
        paymentsHTML = invoice.payments.map((payment, pIdx) => `
            <div class="payment-item">
                <div class="payment-item-info">
                    <div class="payment-item-date">${formatDate(payment.date)}</div>
                    <div class="payment-item-amount">${formatCurrency(payment.amount)}</div>
                    ${payment.note ? `<div style="font-size: 0.9em; color: #666;">${payment.note}</div>` : ''}
                </div>
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-danger btn-small" onclick="deletePayment(${index}, ${pIdx})">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    } else {
        paymentsHTML = '<p style="text-align: center; color: #999;">–ù–µ–º–∞ –µ–≤–∏–¥–µ–Ω—Ç–∏—Ä–∞–Ω–∏ –ø–ª–∞—ú–∞—ö–∞</p>';
    }

    const content = `
        <h3>${invoice.companyName} - ${invoice.invoiceNumber}</h3>
        
        <div class="payment-info">
            <div class="payment-info-row">
                <span>–í–∫—É–ø–µ–Ω –∏–∑–Ω–æ—Å:</span>
                <strong>${formatCurrency(invoice.amount)}</strong>
            </div>
            <div class="payment-info-row">
                <span>–ü–ª–∞—Ç–µ–Ω–æ:</span>
                <strong style="color: #27ae60;">${formatCurrency(totalPaid)}</strong>
            </div>
            <div class="payment-info-row">
                <span>–ü—Ä–µ–æ—Å—Ç–∞–Ω–∞—Ç–æ:</span>
                <strong style="color: #e74c3c;">${formatCurrency(remaining)}</strong>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" style="width: ${progressPercent}%">
                ${progressPercent}%
            </div>
        </div>

        ${remaining > 0 ? `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 15px;">–î–æ–¥–∞–¥–∏ –Ω–æ–≤–æ –ø–ª–∞—ú–∞—ö–µ</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>–ò–∑–Ω–æ—Å (–¥–µ–Ω)</label>
                    <input type="number" id="newPaymentAmount" step="0.01" max="${remaining}" placeholder="–ú–∞–∫—Å: ${remaining}">
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç—É–º</label>
                    <input type="date" id="newPaymentDate" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group full-width">
                    <label>–ó–∞–±–µ–ª–µ—à–∫–∞</label>
                    <input type="text" id="newPaymentNote" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ">
                </div>
            </div>
            <button class="btn btn-success" onclick="addPayment(${index})">‚úì –î–æ–¥–∞–¥–∏ –ø–ª–∞—ú–∞—ö–µ</button>
        </div>
        ` : ''}

        <h4 style="margin-top: 20px; margin-bottom: 10px;">–ò—Å—Ç–æ—Ä–∏—ò–∞ –Ω–∞ –ø–ª–∞—ú–∞—ö–∞</h4>
        <div class="payments-list">
            ${paymentsHTML}
        </div>
    `;

    document.getElementById('paymentModalContent').innerHTML = content;
    document.getElementById('paymentModal').style.display = 'block';
}

function closePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
}

async function addPayment(invoiceIndex) {
    const amount = parseFloat(document.getElementById('newPaymentAmount').value);
    const date = document.getElementById('newPaymentDate').value;
    const note = document.getElementById('newPaymentNote').value;

    if (!amount || amount <= 0) {
        alert('–í–Ω–µ—Å–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω –∏–∑–Ω–æ—Å!');
        return;
    }

    const invoice = invoices[invoiceIndex];
    const totalPaid = invoice.payments ? invoice.payments.reduce((sum, p) => sum + p.amount, 0) : 0;
    const remaining = invoice.amount - totalPaid;

    if (amount > remaining) {
        alert(`–ò–∑–Ω–æ—Å–æ—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –±–∏–¥–µ –ø–æ–≥–æ–ª–µ–º –æ–¥ –ø—Ä–µ–æ—Å—Ç–∞–Ω–∞—Ç–∏–æ—Ç –¥–æ–ª–≥: ${formatCurrency(remaining)}`);
        return;
    }

    if (!invoice.payments) {
        invoice.payments = [];
    }

    invoice.payments.push({
        amount: amount,
        date: date,
        note: note
    });

    await saveToGoogleSheets();
    openPaymentModal(invoiceIndex);
    applyFilters();
}

async function deletePayment(invoiceIndex, paymentIndex) {
    if (!confirm('–î–∞–ª–∏ —Å—Ç–µ —Å–∏–≥—É—Ä–Ω–∏ –¥–µ–∫–∞ —Å–∞–∫–∞—Ç–µ –¥–∞ –≥–æ –∏–∑–±—Ä–∏—à–µ—Ç–µ –æ–≤–∞ –ø–ª–∞—ú–∞—ö–µ?')) return;

    invoices[invoiceIndex].payments.splice(paymentIndex, 1);
    
    await saveToGoogleSheets();
    openPaymentModal(invoiceIndex);
    applyFilters();
}

function exportToExcel() {
    const data = invoices.map(invoice => {
        const totalPaid = invoice.payments ? invoice.payments.reduce((sum, p) => sum + p.amount, 0) : 0;
        const remaining = invoice.amount - totalPaid;
        const status = getInvoiceStatus(invoice);
        
        return {
            '–ö–æ–º–ø–∞–Ω–∏—ò–∞': invoice.companyName,
            '–ë—Ä–æ—ò —Ñ–∞–∫—Ç—É—Ä–∞': invoice.invoiceNumber,
            '–ë—Ä–æ—ò –Ω–∞ —Å–º–µ—Ç–∫–∞': invoice.bankAccount || '',
            '–ò–∑–Ω–æ—Å': invoice.amount,
            '–ü–ª–∞—Ç–µ–Ω–æ': totalPaid,
            '–ü—Ä–µ–æ—Å—Ç–∞–Ω–∞—Ç–æ': remaining,
            '–°—Ç–∞—Ç—É—Å': status === 'paid' ? '–ü–ª–∞—Ç–µ–Ω–∞' : status === 'partial' ? '–î–µ–ª—É–º–Ω–æ' : '–ù–µ–ø–ª–∞—Ç–µ–Ω–∞',
            '–î–∞—Ç—É–º –Ω–∞ –≤–Ω–µ—Å': invoice.entryDate,
            '–†–æ–∫ –∑–∞ –ø–ª–∞—ú–∞—ö–µ': invoice.dueDate,
            '–ó–∞–±–µ–ª–µ—à–∫–∏': invoice.notes || ''
        };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–§–∞–∫—Ç—É—Ä–∏');
    
    const timestamp = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `hotel-koka-fakturi-${timestamp}.xlsx`);
}

function showReport() {
    const stats = {
        total: 0,
        paid: 0,
        partial: 0,
        unpaid: 0,
        totalAmount: 0,
        paidAmount: 0,
        unpaidAmount: 0
    };

    invoices.forEach(invoice => {
        stats.total++;
        stats.totalAmount += invoice.amount;
        
        const totalPaid = invoice.payments ? invoice.payments.reduce((sum, p) => sum + p.amount, 0) : 0;
        stats.paidAmount += totalPaid;
        stats.unpaidAmount += (invoice.amount - totalPaid);
        
        const status = getInvoiceStatus(invoice);
        if (status === 'paid') stats.paid++;
        else if (status === 'partial') stats.partial++;
        else stats.unpaid++;
    });

    const content = `
        <div style="text-align: center; margin-bottom: 30px;">
            <h3>–§–∏–Ω–∞–Ω—Å–∏—Å–∫–∏ –ò–∑–≤–µ—à—Ç–∞—ò</h3>
            <p style="color: #666;">–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω –Ω–∞: ${new Date().toLocaleString('mk-MK')}</p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div style="background: #667eea; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                <h4>–í–∫—É–ø–Ω–æ –§–∞–∫—Ç—É—Ä–∏</h4>
                <p style="font-size: 2em; font-weight: bold;">${stats.total}</p>
            </div>
            <div style="background: #27ae60; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                <h4>–ü–ª–∞—Ç–µ–Ω–∏</h4>
                <p style="font-size: 2em; font-weight: bold;">${stats.paid}</p>
            </div>
            <div style="background: #f39c12; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                <h4>–î–µ–ª—É–º–Ω–æ</h4>
                <p style="font-size: 2em; font-weight: bold;">${stats.partial}</p>
            </div>
            <div style="background: #e74c3c; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                <h4>–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</h4>
                <p style="font-size: 2em; font-weight: bold;">${stats.unpaid}</p>
            </div>
        </div>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <h4 style="margin-bottom: 15px;">–§–∏–Ω–∞–Ω—Å–∏—Å–∫–∏ –ü—Ä–µ–≥–ª–µ–¥</h4>
            <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ddd;">
                <span>–í–∫—É–ø–Ω–∞ —Å—É–º–∞ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∏:</span>
                <strong>${formatCurrency(stats.totalAmount)}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ddd;">
                <span>–ü–ª–∞—Ç–µ–Ω–æ:</span>
                <strong style="color: #27ae60;">${formatCurrency(stats.paidAmount)}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px; border-top: 2px solid #667eea; margin-top: 10px;">
                <span><strong>–ü—Ä–µ–æ—Å—Ç–∞–Ω–∞—Ç–æ –∑–∞ –Ω–∞–ø–ª–∞—Ç–∞:</strong></span>
                <strong style="color: #e74c3c; font-size: 1.2em;">${formatCurrency(stats.unpaidAmount)}</strong>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-success" onclick="exportToExcel()">üì• –ò–∑–≤–µ–∑–∏ –≤–æ Excel</button>
        </div>
    `;

    document.getElementById('reportContent').innerHTML = content;
    document.getElementById('reportModal').style.display = 'block';
}

function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
}

// Event Listeners
document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const invoice = {
        id: generateId(),
        companyName: document.getElementById('companyName').value,
        invoiceNumber: document.getElementById('invoiceNumber').value,
        bankAccount: document.getElementById('bankAccount').value,
        amount: parseFloat(document.getElementById('amount').value) || 0,
        entryDate: document.getElementById('entryDate').value,
        dueDate: document.getElementById('dueDate').value,
        notes: document.getElementById('notes').value,
        payments: [],
        timestamp: new Date().toISOString()
    };

    const initialStatus = document.querySelector('input[name="initialStatus"]:checked')?.value || 'unpaid';

    if (initialStatus === 'paid') {
        invoice.payments.push({
            amount: invoice.amount,
            date: invoice.entryDate,
            note: '–ü–ª–∞—Ç–µ–Ω–æ (–∏–Ω–∏—Ü–∏—ò–∞–ª–Ω–æ)'
        });
    } else if (initialStatus === 'partial') {
        const partialVal = parseFloat(document.getElementById('partialPaidAmount').value || 0);
        if (!(partialVal > 0)) { 
            alert('–í–Ω–µ—Å–∏ –¥–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–∞ —Å—É–º–∞!'); 
            return; 
        }
        if (partialVal >= invoice.amount) { 
            alert('–î–µ–ª—É–º–Ω–∞—Ç–∞ —Å—É–º–∞ –º–æ—Ä–∞ –¥–∞ –µ –ø–æ–º–∞–ª–∞ –æ–¥ –≤–∫—É–ø–Ω–∞—Ç–∞ —Å—É–º–∞!'); 
            return; 
        }

        invoice.payments.push({
            amount: partialVal,
            date: invoice.entryDate,
            note: '–î–µ–ª—É–º–Ω–æ –ø–ª–∞—Ç–µ–Ω–æ (–∏–Ω–∏—Ü–∏—ò–∞–ª–Ω–æ)'
        });
    }

    invoices.push(invoice);
    await saveToGoogleSheets();
    applyFilters();
    closeAddInvoiceModal();

    this.reset();
    const partialInput = document.getElementById('partialPaidAmount');
    if (partialInput) partialInput.value = '';
    updateInitialPaymentUI();
    document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('dueDate').value = new Date().toISOString().split('T')[0];
});

document.getElementById('editForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const index = parseInt(document.getElementById('editIndex').value);
    const invoice = invoices[index];
    
    invoice.companyName = document.getElementById('editCompanyName').value;
    invoice.invoiceNumber = document.getElementById('editInvoiceNumber').value;
    invoice.bankAccount = document.getElementById('editBankAccount').value;
    invoice.amount = parseFloat(document.getElementById('editAmount').value) || 0;
    invoice.entryDate = document.getElementById('editEntryDate').value;
    invoice.dueDate = document.getElementById('editDueDate').value;
    invoice.notes = document.getElementById('editNotes').value;
    invoice.timestamp = new Date().toISOString();

    await saveToGoogleSheets();
    closeEditModal();
    applyFilters();
});

document.getElementById('globalSearch').addEventListener('input', applyFilters);
document.getElementById('filterStatus').addEventListener('change', applyFilters);
document.getElementById('filterCompany').addEventListener('input', applyFilters);
document.getElementById('filterAccount').addEventListener('input', applyFilters);
document.getElementById('filterInvoiceNumber').addEventListener('input', applyFilters);
document.getElementById('filterDateFrom').addEventListener('change', applyFilters);
document.getElementById('filterDateTo').addEventListener('change', applyFilters);

window.onclick = function(event) {
    const editModal = document.getElementById('editModal');
    const reportModal = document.getElementById('reportModal');
    const paymentModal = document.getElementById('paymentModal');
    const addModal = document.getElementById('addInvoiceModal');
    
    if (event.target == editModal) closeEditModal();
    if (event.target == reportModal) closeReportModal();
    if (event.target == paymentModal) closePaymentModal();
    if (event.target == addModal) closeAddInvoiceModal();
}

// Initialize dates
document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
document.getElementById('dueDate').value = new Date().toISOString().split('T')[0];

// Add Invoice Modal Functions
function openAddInvoiceModal() {
    const modal = document.getElementById('addInvoiceModal');
    modal.style.display = 'block';

    const today = new Date().toISOString().split('T')[0];
    const entry = document.getElementById('entryDate');
    const due = document.getElementById('dueDate');
    if (entry && !entry.value) entry.value = today;
    if (due && !due.value) due.value = today;

    updateInitialPaymentUI();

    setTimeout(() => {
        const el = document.getElementById('companyName');
        if (el) el.focus();
    }, 50);
}

function closeAddInvoiceModal() {
    document.getElementById('addInvoiceModal').style.display = 'none';
}

function updateInitialPaymentUI() {
    const statusEl = document.querySelector('input[name="initialStatus"]:checked');
    const status = statusEl ? statusEl.value : 'unpaid';
    const group = document.getElementById('partialPaidGroup');
    if (group) group.style.display = (status === 'partial') ? 'block' : 'none';
}

// Radio listeners
document.querySelectorAll('input[name="initialStatus"]').forEach(r => {
    r.addEventListener('change', updateInitialPaymentUI);
});
updateInitialPaymentUI();

// ESC to close modal
document.addEventListener('keydown', function(event) {
    if (event.key !== 'Escape') return;
    const addModal = document.getElementById('addInvoiceModal');
    if (addModal && addModal.style.display === 'block') closeAddInvoiceModal();
});

// Company history autocomplete
let companyHistory = [];

function updateCompanyHistory() {
    const companies = {};
    invoices.forEach(inv => {
        const key = inv.companyName.toLowerCase();
        if (!companies[key]) {
            companies[key] = {
                name: inv.companyName,
                count: 0,
                lastAccount: inv.bankAccount,
                lastAmount: inv.amount
            };
        }
        companies[key].count++;
        companies[key].lastAccount = inv.bankAccount || companies[key].lastAccount;
    });
    
    companyHistory = Object.values(companies).sort((a, b) => b.count - a.count);
}

document.getElementById('companyName').addEventListener('input', function() {
    const value = this.value.toLowerCase();
    const dropdown = document.getElementById('companyHistory');
    
    if (value.length < 2) {
        dropdown.classList.remove('show');
        return;
    }

    updateCompanyHistory();
    const matches = companyHistory.filter(c => c.name.toLowerCase().includes(value));
    
    if (matches.length === 0) {
        dropdown.classList.remove('show');
        return;
    }

    dropdown.innerHTML = matches.slice(0, 5).map(company => `
        <div class="history-item" onclick="fillCompanyData('${company.name}', '${company.lastAccount || ''}')">
            <div class="history-item-company">${company.name}</div>
            <div class="history-item-details">
                ${company.lastAccount ? `<span class="history-item-account">${company.lastAccount}</span>` : ''}
                <span class="history-badge">${company.count} —Ñ–∞–∫—Ç—É—Ä–∏</span>
            </div>
        </div>
    `).join('');
    
    dropdown.classList.add('show');
});

function fillCompanyData(name, account) {
    document.getElementById('companyName').value = name;
    if (account) document.getElementById('bankAccount').value = account;
    document.getElementById('companyHistory').classList.remove('show');
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('#companyName') && !e.target.closest('#companyHistory')) {
        document.getElementById('companyHistory').classList.remove('show');
    }
});

// Initialize on page load
window.addEventListener('load', async function() {
    console.log('üöÄ Hotel Koka Dashboard loading...');
    
    // Try to load from Google Sheets first
    const sheetsLoaded = await loadFromGoogleSheets();
    
    // If Sheets failed, load from localStorage
    if (!sheetsLoaded) {
        console.log('‚ö†Ô∏è Loading from localStorage as fallback');
        loadFromLocalStorage();
    }
    
    applyFilters();
    console.log('‚úÖ Dashboard ready!');
});

</script>
</body>
</html>
